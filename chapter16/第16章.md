# æ™ºèƒ½ä½“å®æˆ˜ä¹‹èµ„æºæ„ŸçŸ¥ä¼˜åŒ–ï¼šæ™ºèƒ½ç³»ç»Ÿçš„åŠ¨æ€èµ„æºç®¡ç† 
![èµ„æºæ„ŸçŸ¥](chapter16.png)

## ä¸€.ç®€ä»‹

## æ ¸å¿ƒæ¦‚å¿µè§£æ

èµ„æºæ„ŸçŸ¥ä¼˜åŒ–æ˜¯æ™ºèƒ½Agentè®¾è®¡ä¸­çš„å…³é”®ç­–ç•¥ï¼Œå®ƒä½¿ç³»ç»Ÿèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€è¯„ä¼°å’Œè°ƒæ•´è®¡ç®—ã€æ—¶é—´åŠè´¢åŠ¡èµ„æºçš„åˆ†é…ã€‚ä¸ä¼ ç»Ÿè§„åˆ’æ–¹æ³•ä¸åŒï¼Œèµ„æºæ„ŸçŸ¥ä¼˜åŒ–ä¸ä»…å…³æ³¨åŠ¨ä½œåºåˆ—çš„å®‰æ’ï¼Œæ›´æ³¨é‡åœ¨èµ„æºçº¦æŸæ¡ä»¶ä¸‹åšå‡ºæœ€ä¼˜å†³ç­–ã€‚è¿™ç§ä¼˜åŒ–ç­–ç•¥ä½¿Agentèƒ½å¤Ÿæ ¹æ®ä»»åŠ¡éœ€æ±‚å’Œç¯å¢ƒæ¡ä»¶ï¼Œåœ¨æ€§èƒ½ä¸æ•ˆç‡ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹ã€‚

åœ¨èµ„æºæ„ŸçŸ¥ä¼˜åŒ–æ¡†æ¶ä¸‹ï¼Œæ™ºèƒ½ç³»ç»Ÿä¼šæŒç»­ç›‘æ§å¯ç”¨èµ„æºï¼Œå¹¶æ ¹æ®ä»»åŠ¡å¤æ‚æ€§å’Œç´§è¿«æ€§è°ƒæ•´å¤„ç†ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œå½“é¢ä¸´ç®€å•æŸ¥è¯¢æ—¶ï¼Œç³»ç»Ÿå¯èƒ½ä¼šé€‰æ‹©è½»é‡çº§æ¨¡å‹ä»¥èŠ‚çœè®¡ç®—èµ„æºå’Œæˆæœ¬ï¼›è€Œå¯¹äºéœ€è¦æ·±åº¦åˆ†æçš„ä»»åŠ¡ï¼Œåˆ™ä¼šè°ƒç”¨æ›´å¼ºå¤§çš„æ¨¡å‹ï¼Œå³ä½¿è¿™æ„å‘³ç€æ›´é«˜çš„èµ„æºæ¶ˆè€—ã€‚

## å®é™…åº”ç”¨åœºæ™¯

èµ„æºæ„ŸçŸ¥ä¼˜åŒ–åœ¨å¤šä¸ªé¢†åŸŸéƒ½æœ‰å¹¿æ³›åº”ç”¨ï¼š

- **æˆæœ¬æ•ˆç›Šè®¡ç®—**ï¼šæ ¹æ®ä»»åŠ¡å¤æ‚åº¦é€‰æ‹©åˆé€‚çš„æ¨¡å‹ï¼Œå¹³è¡¡æ€§èƒ½ä¸æˆæœ¬
- **å®æ—¶å“åº”ç³»ç»Ÿ**ï¼šåœ¨å»¶è¿Ÿæ•æ„Ÿçš„åº”ç”¨ä¸­é€‰æ‹©å¿«é€Ÿå¤„ç†è·¯å¾„
- **è¾¹ç¼˜è®¡ç®—ä¼˜åŒ–**ï¼šåœ¨èµ„æºå—é™çš„è®¾å¤‡ä¸Šæœ€å¤§åŒ–åŠŸèƒ½ä¸ç”µæ± å¯¿å‘½
- **å¼¹æ€§æœåŠ¡æ¶æ„**ï¼šå®ç°ä¸»å¤‡æ¨¡å‹åˆ‡æ¢ï¼Œç¡®ä¿æœåŠ¡è¿ç»­æ€§
- **æ™ºèƒ½æ•°æ®ç®¡ç†**ï¼šæ ¹æ®ç½‘ç»œæ¡ä»¶é€‰æ‹©æ•°æ®ä¼ è¾“ç­–ç•¥
- **åˆ†å¸ƒå¼ä»»åŠ¡åˆ†é…**ï¼šåœ¨å¤šAgentç³»ç»Ÿä¸­åŠ¨æ€åˆ†é…å·¥ä½œè´Ÿè½½

## äºŒ.å®è·µæ¡ˆä¾‹ï¼šå·¥å‚è´¨é‡æ§åˆ¶ï¼ˆQCï¼‰æµç¨‹agent
æ„å»ºä¸€ä¸ªæ¨¡æ‹Ÿåˆ¶é€ ä¸šçš„æ¡ˆä¾‹ã€‚è¿™ä¸ªæ¡ˆä¾‹å°†æ¨¡æ‹Ÿä¸€ä¸ªå·¥å‚çš„è´¨é‡æ§åˆ¶ï¼ˆQCï¼‰æµç¨‹ï¼Œå…¶ä¸­ç³»ç»Ÿéœ€è¦æ ¹æ®ä¸åŒçš„ç”Ÿäº§è®¢å•è¦æ±‚ï¼ˆå¦‚æ—¶é—´ã€é¢„ç®—å’Œè´¨é‡æ ‡å‡†ï¼‰æ¥é€‰æ‹©æœ€åˆé€‚çš„æ£€æµ‹æ–¹æ³•ã€‚ 

åœºæ™¯è®¾å®š 

å‡è®¾æœ‰ä¸€å®¶ç²¾å¯†é›¶ä»¶åˆ¶é€ å•†ã€‚æ¯ä¸ªç”Ÿäº§æ‰¹æ¬¡åœ¨å‡ºå‚å‰éƒ½éœ€è¦ç»è¿‡è´¨é‡æ£€æµ‹ã€‚æˆ‘ä»¬æœ‰ä¸‰ç§æ£€æµ‹æ–¹æ³•ï¼Œæ¯ç§æ–¹æ³•çš„èµ„æºæ¶ˆè€—ï¼ˆæ—¶é—´ã€æˆæœ¬ï¼‰å’Œæ£€æµ‹ç²¾åº¦éƒ½ä¸åŒï¼š 

    åŸºç¡€äººå·¥ç›®æ£€ï¼š 
         èµ„æºæ¶ˆè€—ï¼šå¿«ï¼Œæˆæœ¬ä½ã€‚
         æ£€æµ‹ç²¾åº¦ï¼šä½ï¼Œåªèƒ½å‘ç°æ˜æ˜¾çš„ç¼ºé™·ã€‚
         é€‚ç”¨åœºæ™¯ï¼šç´§æ€¥è®¢å•ã€ä½æˆæœ¬é›¶ä»¶ã€å¯¹è´¨é‡è¦æ±‚ä¸é«˜çš„æ‰¹æ¬¡ã€‚
          

    æ ‡å‡†ä¼ æ„Ÿå™¨æ£€æµ‹ï¼š 
         èµ„æºæ¶ˆè€—ï¼šä¸­ç­‰æ—¶é—´å’Œæˆæœ¬ã€‚
         æ£€æµ‹ç²¾åº¦ï¼šä¸­ç­‰ï¼Œèƒ½å‘ç°å¤§å¤šæ•°å°ºå¯¸å’Œè¡¨é¢ç¼ºé™·ã€‚
         é€‚ç”¨åœºæ™¯ï¼šæ ‡å‡†ç”Ÿäº§æµç¨‹ï¼Œå¹³è¡¡äº†æ•ˆç‡å’Œè´¨é‡ã€‚
          

    é«˜ç²¾åº¦AIè§†è§‰æ£€æµ‹ï¼š 
         èµ„æºæ¶ˆè€—ï¼šæ…¢ï¼Œæˆæœ¬é«˜ã€‚
         æ£€æµ‹ç²¾åº¦ï¼šéå¸¸é«˜ï¼Œèƒ½å‘ç°å¾®ç±³çº§çš„è£‚çº¹å’Œç‘•ç–µã€‚
         é€‚ç”¨åœºæ™¯ï¼šé«˜ä»·å€¼å®¢æˆ·ã€å…³é”®å®‰å…¨éƒ¨ä»¶ã€å¯¹è´¨é‡æœ‰æè‡´è¦æ±‚çš„æ‰¹æ¬¡ã€‚
          

ç›®æ ‡ï¼šåˆ›å»ºä¸€ä¸ªèµ„æºæ„ŸçŸ¥çš„ç”Ÿäº§ä¼˜åŒ–å™¨ï¼Œå®ƒèƒ½å¤Ÿæ ¹æ®æ¯ä¸ªè®¢å•çš„å…·ä½“çº¦æŸï¼ˆå¦‚äº¤ä»˜æœŸé™ã€æ£€æµ‹é¢„ç®—å’Œè´¨é‡è¦æ±‚ï¼‰ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„æ£€æµ‹æ–¹æ³•ã€‚ 

## ä¸‰.langchainå®ç°
```python
import time
import random
from typing import Dict, Any

from langchain_classic.agents import initialize_agent, AgentType
from langchain_classic.memory import ConversationBufferMemory
from langchain_core.prompts import PromptTemplate
from langchain_core.tools import Tool

from init_client import init_llm

from langchain_core.output_parsers import JsonOutputParser

# --- 1. å®šä¹‰èµ„æºçº¦æŸ ---
class ManufacturingConstraints:
    def __init__(self, time_limit: float, cost_budget: float, quality_threshold: float):
        """
        åˆå§‹åŒ–åˆ¶é€ çº¦æŸæ¡ä»¶

        å‚æ•°:
            time_limit: æ£€æµ‹æ—¶é—´é™åˆ¶ (åˆ†é’Ÿ)
            cost_budget: æ£€æµ‹æˆæœ¬é¢„ç®— (ç¾å…ƒ)
            quality_threshold: æœ€ä½å¯æ¥å—çš„è´¨é‡åˆ†æ•° (0-100)
        """
        self.time_limit = time_limit
        self.cost_budget = cost_budget
        self.quality_threshold = quality_threshold


# --- 2. å®šä¹‰ä¸åŒèµ„æºæ¶ˆè€—çš„æ£€æµ‹å·¥å…· ---
class InspectionMethods:
    @staticmethod
    def basic_visual_inspection(batch_id: str) -> Dict[str, Any]:
        """åŸºç¡€äººå·¥ç›®æ£€ï¼šå¿«é€Ÿã€ä¾¿å®œã€ä½ç²¾åº¦"""
        time.sleep(1)  # æ¨¡æ‹Ÿ1åˆ†é’Ÿçš„æ£€æµ‹æ—¶é—´
        defects_found = random.randint(0, 5)
        quality_score = max(80, 100 - defects_found * 4)
        result = {
            "method_used": "basic_visual_inspection",
            "batch_id": batch_id,
            "defects_found": defects_found,
            "quality_score": quality_score,
            "time_taken": 1.0,
            "cost_incurred": 20.0
        }
        return result

    @staticmethod
    def standard_sensor_inspection(batch_id: str) -> Dict[str, Any]:
        """æ ‡å‡†ä¼ æ„Ÿå™¨æ£€æµ‹ï¼šä¸­ç­‰é€Ÿåº¦ã€ä¸­ç­‰æˆæœ¬ã€ä¸­ç­‰ç²¾åº¦"""
        time.sleep(3)  # æ¨¡æ‹Ÿ3åˆ†é’Ÿçš„æ£€æµ‹æ—¶é—´
        defects_found = random.randint(0, 3)
        quality_score = max(90, 100 - defects_found * 3)
        result = {
            "method_used": "standard_sensor_inspection",
            "batch_id": batch_id,
            "defects_found": defects_found,
            "quality_score": quality_score,
            "time_taken": 3.0,
            "cost_incurred": 75.0
        }
        return result

    @staticmethod
    def precision_ai_inspection(batch_id: str) -> Dict[str, Any]:
        """é«˜ç²¾åº¦AIè§†è§‰æ£€æµ‹ï¼šæ…¢é€Ÿã€æ˜‚è´µã€é«˜ç²¾åº¦"""
        time.sleep(7)  # æ¨¡æ‹Ÿ7åˆ†é’Ÿçš„æ£€æµ‹æ—¶é—´
        defects_found = random.randint(0, 2)
        quality_score = max(98, 100 - defects_found * 1)
        result = {
            "method_used": "precision_ai_inspection",
            "batch_id": batch_id,
            "defects_found": defects_found,
            "quality_score": quality_score,
            "time_taken": 7.0,
            "cost_incurred": 250.0
        }
        return result


# --- 3. èµ„æºæ„ŸçŸ¥ä¼˜åŒ–å™¨---
class ResourceAwareProductionOptimizer:
    def __init__(self):
        # åˆå§‹åŒ–LLM
        self.llm = init_llm(temperature=0.1)

        # åˆ›å»ºå†³ç­–æç¤ºæ¨¡æ¿
        decision_prompt_template = """
        ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åˆ¶é€ ç³»ç»Ÿçš„å†³ç­–æ ¸å¿ƒã€‚è¯·æ ¹æ®ä»¥ä¸‹ç”Ÿäº§è®¢å•çš„çº¦æŸæ¡ä»¶ï¼Œé€‰æ‹©æœ€åˆé€‚çš„è´¨é‡æ£€æµ‹æ–¹æ³•ã€‚

        è®¢å•çº¦æŸ:
        - æ—¶é—´é™åˆ¶: {time_limit} åˆ†é’Ÿ
        - æˆæœ¬é¢„ç®—: ${cost_budget}
        - è´¨é‡è¦æ±‚: æœ€ä½è´¨é‡åˆ†æ•° {quality_threshold}/100

        å¯é€‰çš„æ£€æµ‹æ–¹æ³•åŠå…¶è§„æ ¼:
        | æ–¹æ³•å | é¢„ä¼°è€—æ—¶ | é¢„ä¼°æˆæœ¬ | é¢„ä¼°è´¨é‡åˆ†æ•°èŒƒå›´ |
        |---|---|---|---|
        | basic_visual_inspection | 1.0 åˆ†é’Ÿ | $20 | 80-95 |
        | standard_sensor_inspection | 3.0 åˆ†é’Ÿ | $75 | 90-98 |
        | precision_ai_inspection | 7.0 åˆ†é’Ÿ | $250 | 98-100 |

        ä½ çš„ä»»åŠ¡æ˜¯é€‰æ‹©ä¸€ä¸ª**æ—¢èƒ½æ»¡è¶³æ‰€æœ‰çº¦æŸæ¡ä»¶ï¼Œåˆæœ€å…·æˆæœ¬æ•ˆç›Š**çš„æ–¹æ³•ã€‚
        å¦‚æœæ²¡æœ‰æ–¹æ³•èƒ½åŒæ—¶æ»¡è¶³æ‰€æœ‰çº¦æŸï¼Œè¯·é€‰æ‹©æœ€æ¥è¿‘è¦æ±‚çš„æ–¹æ³•ã€‚

        è¯·åªè¿”å›ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–è§£é‡Šæ€§æ–‡å­—ï¼š
        {{"method": "ä½ é€‰æ‹©çš„æ–¹æ³•å"}}
        """

        self.decision_prompt = PromptTemplate(
            input_variables=["time_limit", "cost_budget", "quality_threshold"],
            template=decision_prompt_template
        )

        # --- åˆ›å»ºå†³ç­–é“¾ ---
        # è¿™ä¸ªé“¾çš„å·¥ä½œæµç¨‹æ˜¯ï¼š
        # 1. æ¥æ”¶ä¸€ä¸ªå­—å…¸ä½œä¸ºè¾“å…¥
        # 2. PromptTemplate ä½¿ç”¨å­—å…¸ä¸­çš„å€¼æ ¼å¼åŒ–æç¤ºè¯
        # 3. LLM æ¥æ”¶æ ¼å¼åŒ–åçš„æç¤ºè¯å¹¶ç”Ÿæˆæ–‡æœ¬å“åº”
        # 4. JsonOutputParser å°è¯•å°†LLMçš„æ–‡æœ¬å“åº”è§£æä¸ºPythonå­—å…¸
        self.decision_chain = self.decision_prompt | self.llm | JsonOutputParser()

    def select_inspection_method(self, constraints: ManufacturingConstraints) -> str:
        """æ ¹æ®çº¦æŸæ¡ä»¶é€‰æ‹©æ£€æµ‹æ–¹æ³•"""
        try:
            decision_dict = self.decision_chain.invoke({
                "time_limit": constraints.time_limit,
                "cost_budget": constraints.cost_budget,
                "quality_threshold": constraints.quality_threshold
            })
            # JsonOutputParserå·²ç»å¸®æˆ‘ä»¬è§£æå¥½äº†ï¼Œç›´æ¥å–å€¼
            return decision_dict["method"]
        except Exception as e:
            # å¦‚æœLLMè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆJSONæˆ–å‘ç”Ÿå…¶ä»–é”™è¯¯ï¼Œæ‰§è¡Œå›é€€é€»è¾‘
            print(f"âš ï¸ LLMå†³ç­–é“¾è§£æå¤±è´¥: {e}ï¼Œä½¿ç”¨é»˜è®¤æ–¹æ³• 'standard_sensor_inspection'")
            return "standard_sensor_inspection"

    def run_qc_process(self, batch_id: str, constraints: ManufacturingConstraints) -> Dict[str, Any]:
        """æ‰§è¡Œå®Œæ•´çš„èµ„æºæ„ŸçŸ¥è´¨é‡æ§åˆ¶æµç¨‹"""
        print(f"ğŸ­ å¼€å§‹ä¸ºæ‰¹æ¬¡ '{batch_id}' è¿›è¡Œè´¨é‡æ§åˆ¶...")
        print(
            f"ğŸ“‹ çº¦æŸæ¡ä»¶: æ—¶é—´é™åˆ¶={constraints.time_limit}åˆ†é’Ÿ, é¢„ç®—=${constraints.cost_budget}, è´¨é‡è¦æ±‚>={constraints.quality_threshold}\n")

        # 1. LLMå†³ç­–é€‰æ‹©æ–¹æ³•
        chosen_method = self.select_inspection_method(constraints)
        print(f"âœ… åˆå§‹å†³ç­–: ä½¿ç”¨ '{chosen_method}' æ–¹æ³•ã€‚\n")

        # 2. æ‰§è¡Œé€‰å®šçš„æ–¹æ³•
        if chosen_method == "basic_visual_inspection":
            result = InspectionMethods.basic_visual_inspection(batch_id)
        elif chosen_method == "standard_sensor_inspection":
            result = InspectionMethods.standard_sensor_inspection(batch_id)
        else:  # precision_ai_inspection
            result = InspectionMethods.precision_ai_inspection(batch_id)

        # 3. éªŒè¯ç»“æœæ˜¯å¦æ»¡è¶³çº¦æŸ
        time_ok = result['time_taken'] <= constraints.time_limit
        cost_ok = result['cost_incurred'] <= constraints.cost_budget
        quality_ok = result['quality_score'] >= constraints.quality_threshold

        result['within_constraints'] = time_ok and cost_ok and quality_ok
        result['initial_choice'] = chosen_method

        # 4. å›é€€æœºåˆ¶
        if not result['within_constraints']:
            print(f"âš ï¸ è­¦å‘Š: åˆå§‹é€‰æ‹© '{chosen_method}' çš„ç»“æœä¸æ»¡è¶³çº¦æŸæ¡ä»¶ï¼")
            print(f"   - è€—æ—¶: {result['time_taken']} (é™åˆ¶: {constraints.time_limit})")
            print(f"   - æˆæœ¬: ${result['cost_incurred']} (é¢„ç®—: ${constraints.cost_budget})")
            print(f"   - è´¨é‡: {result['quality_score']} (è¦æ±‚: {constraints.quality_threshold})")

            # å®æ–½å›é€€ç­–ç•¥
            fallback_method = None
            if chosen_method == "precision_ai_inspection":
                fallback_method = "standard_sensor_inspection"
            elif chosen_method == "standard_sensor_inspection":
                fallback_method = "basic_visual_inspection"

            if fallback_method:
                print(f"ğŸ”„ æ­£åœ¨å›é€€åˆ°æ›´ç»æµçš„æ–¹æ³•: '{fallback_method}'...")
                if fallback_method == "standard_sensor_inspection":
                    result = InspectionMethods.standard_sensor_inspection(batch_id)
                else:
                    result = InspectionMethods.basic_visual_inspection(batch_id)
                result['fallback_used'] = fallback_method
                result['within_constraints'] = (result['time_taken'] <= constraints.time_limit and
                                                result['cost_incurred'] <= constraints.cost_budget and
                                                result['quality_score'] >= constraints.quality_threshold)

        return result


# --- 4. åˆ›å»ºLangChainå·¥å…· ---
def create_langchain_tools(optimizer: ResourceAwareProductionOptimizer) -> list:
    """åˆ›å»ºLangChainå·¥å…·åˆ—è¡¨"""

    def run_quality_control(batch_id: str, time_limit: float, cost_budget: float, quality_threshold: float) -> str:
        """è¿è¡Œè´¨é‡æ§åˆ¶æµç¨‹"""
        constraints = ManufacturingConstraints(time_limit, cost_budget, quality_threshold)
        result = optimizer.run_qc_process(batch_id, constraints)

        report = f"""
        æ‰¹æ¬¡ID: {result['batch_id']}
        æœ€ç»ˆä½¿ç”¨æ–¹æ³•: {result['method_used']}
        å‘ç°ç¼ºé™·æ•°: {result['defects_found']}
        æœ€ç»ˆè´¨é‡åˆ†æ•°: {result['quality_score']}/100
        å®é™…è€—æ—¶: {result['time_taken']} åˆ†é’Ÿ
        å®é™…æˆæœ¬: ${result['cost_incurred']}
        æ˜¯å¦æ»¡è¶³çº¦æŸ: {'æ˜¯' if result['within_constraints'] else 'å¦'}
        """

        if 'fallback_used' in result:
            report += f"\nâš ï¸ å·²ä» '{result['initial_choice']}' å›é€€åˆ° '{result['fallback_used']}'"

        return report

    return [
        Tool(
            name="QualityControl",
            description="æ ¹æ®æ—¶é—´ã€æˆæœ¬å’Œè´¨é‡çº¦æŸè¿è¡Œè´¨é‡æ§åˆ¶æµç¨‹ã€‚è¾“å…¥å‚æ•°ï¼šbatch_id (å­—ç¬¦ä¸²), time_limit (æµ®ç‚¹æ•°), cost_budget (æµ®ç‚¹æ•°), quality_threshold (æµ®ç‚¹æ•°)ã€‚",
            func=run_quality_control
        )
    ]

# --- 5. ä¸»ç¨‹åºä¸æµ‹è¯•æ¡ˆä¾‹ ---
if __name__ == "__main__":
    # åˆå§‹åŒ–èµ„æºæ„ŸçŸ¥ä¼˜åŒ–å™¨
    optimizer = ResourceAwareProductionOptimizer()

    # å®šä¹‰ä¸‰ä¸ªä¸åŒçš„ç”Ÿäº§è®¢å•åœºæ™¯
    scenarios = {
        "ç´§æ€¥è®¢å•": ManufacturingConstraints(time_limit=2.0, cost_budget=50.0, quality_threshold=85.0),
        "æ ‡å‡†è®¢å•": ManufacturingConstraints(time_limit=5.0, cost_budget=100.0, quality_threshold=92.0),
        "é«˜ä»·å€¼å®¢æˆ·è®¢å•": ManufacturingConstraints(time_limit=10.0, cost_budget=300.0, quality_threshold=98.0)
    }

    # ç›´æ¥è¿è¡Œä¼˜åŒ–å™¨
    print("=" * 60)
    print("ç›´æ¥è¿è¡Œèµ„æºæ„ŸçŸ¥ä¼˜åŒ–å™¨")
    print("=" * 60)

    for name, constraints in scenarios.items():
        print(f"\nğŸš€ åœºæ™¯: {name}")
        print("-" * 40)

        batch_id = f"BATCH-{name.replace(' ', '_').upper()}"
        final_report = optimizer.run_qc_process(batch_id, constraints)

        print("\n--- æœ€ç»ˆæŠ¥å‘Š ---")
        print(f"æ‰¹æ¬¡ID: {final_report['batch_id']}")
        print(f"æœ€ç»ˆä½¿ç”¨æ–¹æ³•: {final_report['method_used']}")
        if 'fallback_used' in final_report:
            print(f"âš ï¸ å·²ä» '{final_report['initial_choice']}' å›é€€åˆ° '{final_report['fallback_used']}'")
        print(f"å‘ç°ç¼ºé™·æ•°: {final_report['defects_found']}")
        print(f"æœ€ç»ˆè´¨é‡åˆ†æ•°: {final_report['quality_score']}/100")
        print(f"å®é™…è€—æ—¶: {final_report['time_taken']} åˆ†é’Ÿ")
        print(f"å®é™…æˆæœ¬: ${final_report['cost_incurred']}")
        print(f"æ˜¯å¦æ»¡è¶³çº¦æŸ: {'âœ… æ˜¯' if final_report['within_constraints'] else 'âŒ å¦'}")
        print("-" * 40)

    # ä½¿ç”¨LangChain Agent
    print("\n\n" + "=" * 60)
    print("ä½¿ç”¨LangChain Agentè¿›è¡Œèµ„æºæ„ŸçŸ¥ä¼˜åŒ–")
    print("=" * 60)

    # åˆ›å»ºå·¥å…·
    tools = create_langchain_tools(optimizer)

    # åˆ›å»ºå†…å­˜
    memory = ConversationBufferMemory(memory_key="chat_history", return_messages=True)

    # åˆå§‹åŒ–Agent
    agent = initialize_agent(
        tools=tools,
        llm=optimizer.llm,
        agent=AgentType.CONVERSATIONAL_REACT_DESCRIPTION,
        memory=memory,
        verbose=True
    )

    # æµ‹è¯•Agent
    print("\nè¯·è¾“å…¥æ‚¨çš„è¦æ±‚ï¼ˆä¾‹å¦‚ï¼šå¯¹æ‰¹æ¬¡URGENT_001è¿›è¡Œè´¨é‡æ§åˆ¶ï¼Œæ—¶é—´é™åˆ¶2åˆ†é’Ÿï¼Œé¢„ç®—50ç¾å…ƒï¼Œè´¨é‡è¦æ±‚85åˆ†ï¼‰ï¼š")
    user_input = input("> ")

    response = agent.run(user_input)
    print("\nAgentå“åº”:")
    print(response)
```

## é¡¹ç›®åˆ†æ

### æ ¸å¿ƒæ€æƒ³ï¼šä»€ä¹ˆæ˜¯èµ„æºæ„ŸçŸ¥ä¼˜åŒ–ï¼Ÿ

åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œâ€œèµ„æºâ€è¢«æ˜ç¡®å®šä¹‰ä¸ºä¸‰ä¸ªç»´åº¦ï¼š
1.  **æ—¶é—´**ï¼šå®Œæˆä»»åŠ¡æ‰€éœ€çš„æ—¶é—´ã€‚
2.  **æˆæœ¬**ï¼šå®Œæˆä»»åŠ¡æ‰€éœ€çš„è´¢åŠ¡é¢„ç®—ã€‚
3.  **è´¨é‡**ï¼šä»»åŠ¡éœ€è¦è¾¾æˆçš„æœ€ä½æ ‡å‡†ã€‚

**èµ„æºæ„ŸçŸ¥ä¼˜åŒ–**å°±æ˜¯Agentåœ¨æ‰§è¡Œä»»åŠ¡ï¼ˆè¿™é‡Œæ˜¯è´¨æ£€ï¼‰å‰ï¼Œé¦–å…ˆ**è¯„ä¼°**å½“å‰ä»»åŠ¡çš„èµ„æºé™åˆ¶ï¼Œç„¶å**åŠ¨æ€é€‰æ‹©**ä¸€ä¸ªèƒ½å¤Ÿåœ¨è¿™äº›é™åˆ¶å†…å®Œæˆä»»åŠ¡çš„**æœ€ä¼˜æ–¹æ³•**ã€‚å¦‚æœé€‰æ‹©çš„æ–¹æ³•è¶…å‡ºäº†é™åˆ¶ï¼Œå®ƒè¿˜èƒ½å¯åŠ¨**å›é€€æœºåˆ¶**ï¼Œç¡®ä¿ç³»ç»Ÿä¸ä¼šå´©æºƒï¼Œè€Œæ˜¯æä¾›ä¸€ä¸ªâ€œé™çº§â€ä½†å¯ç”¨çš„æœåŠ¡ã€‚

---

### ä»£ç ç»“æ„è§£æï¼šå„ç»„ä»¶å¦‚ä½•ååŒå®ç°èµ„æºæ„ŸçŸ¥

æˆ‘ä»¬å¯ä»¥å°†æ•´ä¸ªç³»ç»Ÿæ‹†åˆ†ä¸ºå››ä¸ªå…³é”®éƒ¨åˆ†ï¼Œæ¯ä¸€éƒ¨åˆ†éƒ½ä¸ºèµ„æºæ„ŸçŸ¥ä¼˜åŒ–è´¡çŒ®äº†é‡è¦åŠŸèƒ½ã€‚

#### 1. èµ„æºçš„å®šä¹‰ï¼š`ManufacturingConstraints` ç±»

```python
class ManufacturingConstraints:
    def __init__(self, time_limit: float, cost_budget: float, quality_threshold: float):
        self.time_limit = time_limit
        self.cost_budget = cost_budget
        self.quality_threshold = quality_threshold
```

*   **è§’è‰²**ï¼š**è§„åˆ™çš„é‡åŒ–**ã€‚è¿™ä¸ªç±»æœ¬èº«ä¸åšä»»ä½•å†³ç­–ï¼Œä½†å®ƒè‡³å…³é‡è¦ã€‚å®ƒå°†â€œæ—¶é—´å¾ˆç´§â€ã€â€œé¢„ç®—ä¸å¤šâ€ã€â€œè´¨é‡è¦æ±‚é«˜â€è¿™ç±»æ¨¡ç³Šçš„è‡ªç„¶è¯­è¨€æè¿°ï¼Œè½¬åŒ–ä¸ºäº†æœºå™¨å¯ä»¥ç†è§£å’Œè®¡ç®—çš„ç²¾ç¡®æ•°å­—ã€‚
*   **èµ„æºæ„ŸçŸ¥ä½“ç°**ï¼šè¿™æ˜¯èµ„æºæ„ŸçŸ¥çš„**åŸºç¡€**ã€‚æ²¡æœ‰å¯¹èµ„æºçš„æ¸…æ™°å®šä¹‰ï¼Œä»»ä½•ä¼˜åŒ–éƒ½æ— ä»è°ˆèµ·ã€‚å®ƒä¸ºåç»­çš„å†³ç­–æä¾›äº†æ˜ç¡®çš„â€œè¾¹ç•Œâ€ã€‚

#### 2. å·¥å…·çš„æƒè¡¡ï¼š`InspectionMethods` ç±»

```python
class InspectionMethods:
    @staticmethod
    def basic_visual_inspection(...): # ä½èµ„æºæ¶ˆè€—ï¼Œä½è´¨é‡
        # ...
        return {"time_taken": 1.0, "cost_incurred": 20.0, "quality_score": ...}

    @staticmethod
    def standard_sensor_inspection(...): # ä¸­ç­‰èµ„æºæ¶ˆè€—ï¼Œä¸­ç­‰è´¨é‡
        # ...
        return {"time_taken": 3.0, "cost_incurred": 75.0, "quality_score": ...}

    @staticmethod
    def precision_ai_inspection(...): # é«˜èµ„æºæ¶ˆè€—ï¼Œé«˜è´¨é‡
        # ...
        return {"time_taken": 7.0, "cost_incurred": 250.0, "quality_score": ...}
```

*   **è§’è‰²**ï¼š**å¯é€‰çš„ç­–ç•¥é›†**ã€‚è¿™ä¸ªç±»æä¾›äº†ä¸‰ç§ä¸åŒçš„â€œå·¥å…·â€æˆ–â€œæ–¹æ³•â€ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½ä»£è¡¨äº†ä¸€ç§ç‹¬ç‰¹çš„èµ„æºä¸äº§å‡ºçš„**æƒè¡¡**ã€‚
*   **èµ„æºæ„ŸçŸ¥ä½“ç°**ï¼šè¿™æ˜¯èµ„æºæ„ŸçŸ¥çš„**æ ¸å¿ƒé€‰é¡¹**ã€‚Agentçš„ä¼˜åŒ–èƒ½åŠ›å°±ä½“ç°åœ¨èƒ½ä»è¿™äº›å…·æœ‰ä¸åŒèµ„æºæ¶ˆè€—å’Œäº§å‡ºè´¨é‡çš„é€‰é¡¹ä¸­ï¼ŒæŒ‘é€‰å‡ºæœ€åˆé€‚çš„ä¸€ä¸ªã€‚å®ƒæ¸…æ™°åœ°å±•ç¤ºäº†â€œæ²¡æœ‰å…è´¹çš„åˆé¤â€è¿™ä¸€åŸåˆ™ï¼šé«˜è´¨é‡å¿…ç„¶ä¼´éšç€é«˜æ—¶é—´å’Œæˆæœ¬æ¶ˆè€—ã€‚

#### 3. æ™ºèƒ½å†³ç­–ä¸æ‰§è¡Œï¼š`ResourceAwareProductionOptimizer` ç±»

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„**å¤§è„‘**ï¼Œèµ„æºæ„ŸçŸ¥ä¼˜åŒ–é€»è¾‘çš„é›†ä¸­ä½“ç°ã€‚

##### A. å†³ç­–æ ¸å¿ƒï¼šä½¿ç”¨ LCEL é“¾è¿›è¡Œæ™ºèƒ½æ¨ç†

```python
# åœ¨ __init__ æ–¹æ³•ä¸­
self.decision_chain = self.decision_prompt | self.llm | JsonOutputParser()

# åœ¨ select_inspection_method æ–¹æ³•ä¸­
decision_dict = self.decision_chain.invoke({
    "time_limit": constraints.time_limit,
    "cost_budget": constraints.cost_budget,
    "quality_threshold": constraints.quality_threshold
})
```

*   **è§’è‰²**ï¼š**æ™ºèƒ½åˆ†æå¼•æ“**ã€‚è¿™é‡Œæ²¡æœ‰ä½¿ç”¨ç®€å•çš„ `if-else` è§„åˆ™ï¼Œè€Œæ˜¯åˆ©ç”¨äº†LLMï¼ˆDeepSeekï¼‰çš„**æ¨ç†èƒ½åŠ›**ã€‚
*   **èµ„æºæ„ŸçŸ¥ä½“ç°**ï¼š
    1.  **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼š`decision_prompt` æ¨¡æ¿å°† `ManufacturingConstraints`ï¼ˆè§„åˆ™ï¼‰å’Œ `InspectionMethods` çš„è§„æ ¼ï¼ˆé€‰é¡¹ï¼‰ä¸€åŒæ³¨å…¥ç»™LLMã€‚è¿™ä½¿å¾—LLMåƒä¸€ä¸ªçœŸæ­£çš„ä¸“å®¶ä¸€æ ·ï¼Œåœ¨å……åˆ†äº†è§£æ‰€æœ‰ä¿¡æ¯åè¿›è¡Œåˆ¤æ–­ã€‚
    2.  **åŠ¨æ€å†³ç­–**ï¼šå¯¹äºæ¯ä¸€ä¸ªæ–°çš„è®¢å•çº¦æŸï¼ŒLLMéƒ½ä¼šé‡æ–°è¿›è¡Œåˆ†æï¼Œè€Œä¸æ˜¯éµå¾ªæ­»æ¿çš„è§„åˆ™ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½åˆ¤æ–­å‡ºï¼Œå³ä½¿æ—¶é—´å¾ˆç´§ï¼Œä½†å¦‚æœè´¨é‡è¦æ±‚æé«˜ï¼Œé‚£ä¹ˆ`standard_sensor_inspection`æ˜¯å”¯ä¸€å¯è¡Œçš„é€‰é¡¹ï¼Œè€Œ`basic_visual_inspection`åˆ™å®Œå…¨ä¸æ»¡è¶³è¦æ±‚ã€‚è¿™ç§åŠ¨æ€æ€§æ˜¯é«˜çº§èµ„æºæ„ŸçŸ¥çš„å…³é”®ã€‚

##### B. å®Œæ•´å·¥ä½œæµï¼š`run_qc_process` æ–¹æ³•

è¿™ä¸ªæ–¹æ³•å±•ç¤ºäº†ä»å†³ç­–åˆ°éªŒè¯çš„å®Œæ•´é—­ç¯ã€‚

```python
def run_qc_process(self, batch_id: str, constraints: ManufacturingConstraints):
    # 1. LLMå†³ç­–é€‰æ‹©æ–¹æ³•
    chosen_method = self.select_inspection_method(constraints)

    # 2. æ‰§è¡Œé€‰å®šçš„æ–¹æ³•
    # ... è°ƒç”¨ InspectionMethods ä¸­çš„æ–¹æ³• ...

    # 3. ã€å…³é”®ã€‘éªŒè¯ç»“æœæ˜¯å¦æ»¡è¶³çº¦æŸ
    time_ok = result['time_taken'] <= constraints.time_limit
    cost_ok = result['cost_incurred'] <= constraints.cost_budget
    quality_ok = result['quality_score'] >= constraints.quality_threshold
    result['within_constraints'] = time_ok and cost_ok and quality_ok

    # 4. ã€å…³é”®ã€‘å›é€€æœºåˆ¶
    if not result['within_constraints']:
        # ... è§¦å‘å›é€€é€»è¾‘ï¼Œé€‰æ‹©æ›´ç®€å•çš„æ–¹æ³• ...
```

*   **è§’è‰²**ï¼š**æ‰§è¡Œä¸è‡ªæˆ‘ä¿®æ­£**ã€‚
*   **èµ„æºæ„ŸçŸ¥ä½“ç°**ï¼š
    1.  **éªŒè¯**ï¼šè¿™æ˜¯èµ„æºæ„ŸçŸ¥çš„**ä¿é™©ä¸**ã€‚ç³»ç»Ÿå¹¶ä¸ç›²ç›®ä¿¡ä»»LLMçš„å†³ç­–ã€‚åœ¨æ‰§è¡Œå®Œä»»åŠ¡åï¼Œå®ƒä¼š**é‡æ–°è®¡ç®—**å®é™…æ¶ˆè€—çš„èµ„æºï¼Œå¹¶ä¸æœ€åˆçš„ `ManufacturingConstraints` è¿›è¡Œæ¯”è¾ƒã€‚è¿™ç¡®ä¿äº†å†³ç­–çš„æœ€ç»ˆæœ‰æ•ˆæ€§ã€‚
    2.  **å›é€€æœºåˆ¶**ï¼šè¿™æ˜¯èµ„æºæ„ŸçŸ¥çš„**é²æ£’æ€§ä¿éšœ**ã€‚å½“éªŒè¯å¤±è´¥æ—¶ï¼ˆä¾‹å¦‚ï¼ŒLLMé€‰æ‹©çš„â€œé«˜ç²¾åº¦AIæ£€æµ‹â€å®é™…èŠ±è´¹è¶…å‡ºäº†é¢„ç®—ï¼‰ï¼Œç³»ç»Ÿä¸ä¼šå´©æºƒæˆ–æŠ¥å‘Šé”™è¯¯ã€‚å®ƒä¼šå¯åŠ¨ä¸€ä¸ªé¢„è®¾çš„ã€æ›´ä¿å®ˆçš„**å›é€€ç­–ç•¥**ï¼Œè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªæ›´ç®€å•ã€æ›´çœèµ„æºçš„æ–¹æ³•ã€‚è¿™å®ç°äº†**ä¼˜é›…é™çº§**ï¼Œç¡®ä¿åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½ç»™å‡ºä¸€ä¸ªç»“æœï¼Œè€Œä¸æ˜¯å®Œå…¨å¤±è´¥ã€‚

#### 4. äººæœºäº¤äº’å±‚ï¼šLangChain Agent

```python
agent = initialize_agent(
    tools=tools,
    llm=optimizer.llm,
    agent=AgentType.CONVERSATIONAL_REACT_DESCRIPTION,
    # ...
)
response = agent.run("å¯¹æ‰¹æ¬¡URGENT_001è¿›è¡Œè´¨é‡æ§åˆ¶ï¼Œæ—¶é—´é™åˆ¶2åˆ†é’Ÿï¼Œé¢„ç®—50ç¾å…ƒ...")
```

*   **è§’è‰²**ï¼š**æ„å›¾è½¬æ¢å™¨**ã€‚
*   **èµ„æºæ„ŸçŸ¥ä½“ç°**ï¼šAgentæœ¬èº«ä¸æ‰§è¡Œä¼˜åŒ–ï¼Œä½†å®ƒå°†ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŒ‡ä»¤ï¼ˆâ€œæ—¶é—´é™åˆ¶2åˆ†é’Ÿï¼Œé¢„ç®—50ç¾å…ƒâ€ï¼‰**ç¿»è¯‘**æˆ `ResourceAwareProductionOptimizer` æ‰€éœ€çš„ç²¾ç¡®å‚æ•°ï¼ˆ`time_limit=2.0`, `cost_budget=50.0`ï¼‰ã€‚å®ƒæå¤§åœ°é™ä½äº†ä½¿ç”¨è¿™ä¸ªå¤æ‚ç³»ç»Ÿçš„é—¨æ§›ï¼Œè®©éæŠ€æœ¯äººå‘˜ä¹Ÿèƒ½åˆ©ç”¨å…¶å¼ºå¤§çš„èµ„æºæ„ŸçŸ¥èƒ½åŠ›ã€‚

### æ€»ç»“

è¿™ä¸ªæ¡ˆä¾‹é€šè¿‡ä»¥ä¸‹æ­¥éª¤ï¼Œå‡ºè‰²åœ°å®ç°äº†èµ„æºæ„ŸçŸ¥ä¼˜åŒ–ï¼š

1.  **å®šä¹‰èµ„æº** (`ManufacturingConstraints`)ï¼šå°†æ¨¡ç³Šçš„éœ€æ±‚é‡åŒ–ä¸ºå¯è®¡ç®—çš„çº¦æŸã€‚
2.  **æä¾›é€‰é¡¹** (`InspectionMethods`)ï¼šåˆ›å»ºä¸€ç»„å…·æœ‰ä¸åŒèµ„æºæ¶ˆè€—å’Œäº§å‡ºçš„å·¥å…·ã€‚
3.  **æ™ºèƒ½å†³ç­–** (`ResourceAwareProductionOptimizer` + LCEL)ï¼š
    *   åˆ©ç”¨LLMçš„æ¨ç†èƒ½åŠ›ï¼Œæ ¹æ®çº¦æŸåŠ¨æ€é€‰æ‹©æœ€ä½³å·¥å…·ã€‚
    *   **éªŒè¯**æ‰§è¡Œç»“æœæ˜¯å¦çœŸçš„åœ¨çº¦æŸèŒƒå›´å†…ã€‚
    *   å¦‚æœè¶…å‡ºçº¦æŸï¼Œåˆ™å¯åŠ¨**å›é€€æœºåˆ¶**ï¼Œç¡®ä¿ç³»ç»Ÿçš„é²æ£’æ€§ã€‚
4.  **ç®€åŒ–äº¤äº’** (LangChain Agent)ï¼šé€šè¿‡è‡ªç„¶è¯­è¨€æ¥å£ï¼Œè®©ç”¨æˆ·å¯ä»¥è½»æ¾åœ°æŒ‡å®šèµ„æºçº¦æŸã€‚

## å››.langgraphå®ç°
```python
import time
import random
from typing import Dict, Any, TypedDict, Annotated, List

# å¯¼å…¥LangGraphç›¸å…³åº“
from langgraph.graph import StateGraph, END
from langgraph.checkpoint.memory import MemorySaver
from langchain_core.messages import HumanMessage, AIMessage
from langchain_core.prompts import PromptTemplate
from langchain_core.output_parsers import JsonOutputParser

from init_client import init_llm

# --- 1. å®šä¹‰çŠ¶æ€ ---
# ä½¿ç”¨ TypedDict å®šä¹‰å›¾ä¸­èŠ‚ç‚¹ä¹‹é—´ä¼ é€’çš„çŠ¶æ€
class InspectionState(TypedDict):
    batch_id: str
    constraints: Dict[str, float]
    initial_decision: str
    final_decision: str
    inspection_result: Dict[str, Any]
    is_within_constraints: bool
    messages: Annotated[List[HumanMessage | AIMessage], "Messages"]


# --- 2. å®šä¹‰èµ„æºçº¦æŸå’Œæ£€æµ‹å·¥å…· ---
class ManufacturingConstraints:
    def __init__(self, time_limit: float, cost_budget: float, quality_threshold: float):
        self.time_limit = time_limit
        self.cost_budget = cost_budget
        self.quality_threshold = quality_threshold


class InspectionMethods:
    @staticmethod
    def basic_visual_inspection(batch_id: str) -> Dict[str, Any]:
        time.sleep(1)
        defects_found = random.randint(0, 5)
        quality_score = max(80, 100 - defects_found * 4)
        return {
            "method_used": "basic_visual_inspection",
            "batch_id": batch_id, "defects_found": defects_found, "quality_score": quality_score,
            "time_taken": 1.0, "cost_incurred": 20.0
        }

    @staticmethod
    def standard_sensor_inspection(batch_id: str) -> Dict[str, Any]:
        time.sleep(3)
        defects_found = random.randint(0, 3)
        quality_score = max(90, 100 - defects_found * 3)
        return {
            "method_used": "standard_sensor_inspection",
            "batch_id": batch_id, "defects_found": defects_found, "quality_score": quality_score,
            "time_taken": 3.0, "cost_incurred": 75.0
        }

    @staticmethod
    def precision_ai_inspection(batch_id: str) -> Dict[str, Any]:
        time.sleep(7)
        defects_found = random.randint(0, 2)
        quality_score = max(98, 100 - defects_found * 1)
        return {
            "method_used": "precision_ai_inspection",
            "batch_id": batch_id, "defects_found": defects_found, "quality_score": quality_score,
            "time_taken": 7.0, "cost_incurred": 250.0
        }


# --- 3. å®šä¹‰å›¾çš„èŠ‚ç‚¹ ---

# èŠ‚ç‚¹1: æ™ºèƒ½å†³ç­–
def agent_node(state: InspectionState):
    llm = init_llm(temperature=0.1)

    decision_prompt = PromptTemplate(
        input_variables=["time_limit", "cost_budget", "quality_threshold"],
        template="""
        ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åˆ¶é€ ç³»ç»Ÿçš„å†³ç­–æ ¸å¿ƒã€‚è¯·æ ¹æ®ä»¥ä¸‹ç”Ÿäº§è®¢å•çš„çº¦æŸæ¡ä»¶ï¼Œé€‰æ‹©æœ€åˆé€‚çš„è´¨é‡æ£€æµ‹æ–¹æ³•ã€‚

        è®¢å•çº¦æŸ:
        - æ—¶é—´é™åˆ¶: {time_limit} åˆ†é’Ÿ
        - æˆæœ¬é¢„ç®—: ${cost_budget}
        - è´¨é‡è¦æ±‚: æœ€ä½è´¨é‡åˆ†æ•° {quality_threshold}/100

        å¯é€‰çš„æ£€æµ‹æ–¹æ³•åŠå…¶è§„æ ¼:
        | æ–¹æ³•å | é¢„ä¼°è€—æ—¶ | é¢„ä¼°æˆæœ¬ | é¢„ä¼°è´¨é‡åˆ†æ•°èŒƒå›´ |
        |---|---|---|---|
        | basic_visual_inspection | 1.0 åˆ†é’Ÿ | $20 | 80-95 |
        | standard_sensor_inspection | 3.0 åˆ†é’Ÿ | $75 | 90-98 |
        | precision_ai_inspection | 7.0 åˆ†é’Ÿ | $250 | 98-100 |

        ä½ çš„ä»»åŠ¡æ˜¯é€‰æ‹©ä¸€ä¸ª**æ—¢èƒ½æ»¡è¶³æ‰€æœ‰çº¦æŸæ¡ä»¶ï¼Œåˆæœ€å…·æˆæœ¬æ•ˆç›Š**çš„æ–¹æ³•ã€‚
        å¦‚æœæ²¡æœ‰æ–¹æ³•èƒ½åŒæ—¶æ»¡è¶³æ‰€æœ‰çº¦æŸï¼Œè¯·é€‰æ‹©æœ€æ¥è¿‘è¦æ±‚çš„æ–¹æ³•ã€‚

        è¯·åªè¿”å›ä¸€ä¸ªJSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼Œä¸è¦åŒ…å«ä»»ä½•å…¶ä»–è§£é‡Šæ€§æ–‡å­—ï¼š
        {{"method": "ä½ é€‰æ‹©çš„æ–¹æ³•å"}}
        """
    )

    decision_chain = decision_prompt | llm | JsonOutputParser()

    decision = decision_chain.invoke(state["constraints"])

    print(f"ğŸ¤– Agentå†³ç­–: é€‰æ‹© '{decision['method']}' æ–¹æ³•ã€‚")
    return {"initial_decision": decision['method'], "messages": [AIMessage(content=f"å†³ç­–é€‰æ‹©: {decision['method']}")]}


# èŠ‚ç‚¹2: æ‰§è¡Œæ£€æµ‹
def execute_inspection_node(state: InspectionState):
    method_to_call = state["initial_decision"]
    batch_id = state["batch_id"]

    if method_to_call == "basic_visual_inspection":
        result = InspectionMethods.basic_visual_inspection(batch_id)
    elif method_to_call == "standard_sensor_inspection":
        result = InspectionMethods.standard_sensor_inspection(batch_id)
    else:  # precision_ai_inspection
        result = InspectionMethods.precision_ai_inspection(batch_id)

    print(f"ğŸ”§ æ‰§è¡Œæ£€æµ‹: ä½¿ç”¨ '{method_to_call}' å®Œæˆã€‚")
    return {"inspection_result": result, "final_decision": method_to_call}


# èŠ‚ç‚¹3: éªŒè¯çº¦æŸ
def check_constraints_node(state: InspectionState):
    result = state["inspection_result"]
    constraints = state["constraints"]

    time_ok = result['time_taken'] <= constraints['time_limit']
    cost_ok = result['cost_incurred'] <= constraints['cost_budget']
    quality_ok = result['quality_score'] >= constraints['quality_threshold']

    is_ok = time_ok and cost_ok and quality_ok

    print(f"ğŸ” éªŒè¯çº¦æŸ: {'âœ… æ»¡è¶³' if is_ok else 'âŒ ä¸æ»¡è¶³'}æ‰€æœ‰çº¦æŸã€‚")
    return {"is_within_constraints": is_ok}


# èŠ‚ç‚¹4: å›é€€å†³ç­–
def fallback_node(state: InspectionState):
    initial_choice = state["initial_decision"]
    fallback_method = "basic_visual_inspection"  # é»˜è®¤å›é€€

    if initial_choice == "precision_ai_inspection":
        fallback_method = "standard_sensor_inspection"
    elif initial_choice == "standard_sensor_inspection":
        fallback_method = "basic_visual_inspection"

    print(f"âš ï¸ è§¦å‘å›é€€: ä» '{initial_choice}' å›é€€åˆ° '{fallback_method}'ã€‚")
    return {"final_decision": fallback_method, "messages": [AIMessage(content=f"å›é€€åˆ°: {fallback_method}")]}


# èŠ‚ç‚¹5: æ‰§è¡Œå›é€€åçš„æ£€æµ‹
def execute_fallback_node(state: InspectionState):
    method_to_call = state["final_decision"]
    batch_id = state["batch_id"]

    if method_to_call == "basic_visual_inspection":
        result = InspectionMethods.basic_visual_inspection(batch_id)
    else:  # standard_sensor_inspection
        result = InspectionMethods.standard_sensor_inspection(batch_id)

    print(f"ğŸ”§ æ‰§è¡Œå›é€€æ£€æµ‹: ä½¿ç”¨ '{method_to_call}' å®Œæˆã€‚")
    return {"inspection_result": result}


# èŠ‚ç‚¹6: ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
def final_report_node(state: InspectionState):
    result = state["inspection_result"]
    constraints = state["constraints"]

    report = f"""
    ================== æœ€ç»ˆæŠ¥å‘Š ==================
    æ‰¹æ¬¡ID: {result['batch_id']}
    åˆå§‹å†³ç­–æ–¹æ³•: {state['initial_decision']}
    æœ€ç»ˆæ‰§è¡Œæ–¹æ³•: {state['final_decision']}
    å‘ç°ç¼ºé™·æ•°: {result['defects_found']}
    æœ€ç»ˆè´¨é‡åˆ†æ•°: {result['quality_score']}/100
    å®é™…è€—æ—¶: {result['time_taken']} åˆ†é’Ÿ (é™åˆ¶: {constraints['time_limit']})
    å®é™…æˆæœ¬: ${result['cost_incurred']} (é¢„ç®—: ${constraints['cost_budget']})
    ============================================
    """
    print(report)
    return {"messages": [AIMessage(content=report)]}


# --- 4. æ„å»ºçŠ¶æ€å›¾ ---
def build_graph():
    # åˆ›å»ºä¸€ä¸ªæ–°çš„çŠ¶æ€å›¾
    workflow = StateGraph(InspectionState)

    # æ·»åŠ èŠ‚ç‚¹
    workflow.add_node("agent", agent_node)
    workflow.add_node("execute_inspection", execute_inspection_node)
    workflow.add_node("check_constraints", check_constraints_node)
    workflow.add_node("fallback", fallback_node)
    workflow.add_node("execute_fallback", execute_fallback_node)
    workflow.add_node("final_report", final_report_node)

    # å®šä¹‰è¾¹
    workflow.set_entry_point("agent")
    workflow.add_edge("agent", "execute_inspection")
    workflow.add_edge("execute_inspection", "check_constraints")

    # æ·»åŠ æ¡ä»¶è¾¹
    workflow.add_conditional_edges(
        "check_constraints",
        lambda state: "fallback" if not state["is_within_constraints"] else "final_report",
        {
            "fallback": "fallback",
            "final_report": "final_report"
        }
    )

    workflow.add_edge("fallback", "execute_fallback")
    workflow.add_edge("execute_fallback", "final_report")

    workflow.add_edge("final_report", END)

    # ç¼–è¯‘å›¾
    memory = MemorySaver()
    app = workflow.compile(checkpointer=memory)
    return app


# --- 5. ä¸»ç¨‹åºä¸æµ‹è¯• ---
if __name__ == "__main__":
    # æ„å»ºå›¾
    qc_graph = build_graph()
    # å¯é€‰ï¼šå¯è§†åŒ–å›¾çš„ç»“æ„
    qc_graph.get_graph().print_ascii()

    # å®šä¹‰æµ‹è¯•åœºæ™¯
    scenarios = {
        "ç´§æ€¥è®¢å•": ManufacturingConstraints(time_limit=2.0, cost_budget=50.0, quality_threshold=85.0),
        "æ ‡å‡†è®¢å•": ManufacturingConstraints(time_limit=5.0, cost_budget=100.0, quality_threshold=92.0),
        "é«˜ä»·å€¼å®¢æˆ·è®¢å•": ManufacturingConstraints(time_limit=10.0, cost_budget=300.0, quality_threshold=98.0)
    }

    # éå†å¹¶è¿è¡Œæ¯ä¸ªåœºæ™¯
    for name, constraints in scenarios.items():
        print("=" * 60)
        print(f"ğŸš€ åœºæ™¯: {name}")
        print("=" * 60)

        # åˆå§‹åŒ–çŠ¶æ€
        initial_state = {
            "batch_id": f"BATCH-{name.replace(' ', '_').upper()}",
            "constraints": {
                "time_limit": constraints.time_limit,
                "cost_budget": constraints.cost_budget,
                "quality_threshold": constraints.quality_threshold
            },
            "messages": []
        }

        # è°ƒç”¨å›¾æ¥æ‰§è¡Œæµç¨‹
        # ä½¿ç”¨ thread_id æ¥ä¸ºæ¯ä¸ªå¯¹è¯åˆ›å»ºç‹¬ç«‹çš„æ£€æŸ¥ç‚¹
        final_state = qc_graph.invoke(initial_state, config={"configurable": {"thread_id": name}})

        print("\n--- æµç¨‹ç»“æŸ ---")
        print("-" * 60 + "\n")
```

## é¡¹ç›®åˆ†æ

### æ ¸å¿ƒæ€æƒ³ï¼šä»â€œéšå¼æ¨ç†â€åˆ°â€œæ˜¾å¼å·¥ä½œæµâ€

åœ¨ä¹‹å‰çš„ LangChain Agent æˆ– LCEL æ¡ˆä¾‹ä¸­ï¼ŒAgent çš„â€œæ™ºèƒ½â€å’Œâ€œå·¥ä½œæµâ€åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ç”± LLM çš„æ¨ç†èƒ½åŠ›é©±åŠ¨çš„ï¼Œæµç¨‹ç›¸å¯¹**éšå¼**ã€‚è€Œ LangGraph çš„æ ¹æœ¬æ€§æ”¹å˜åœ¨äºï¼Œå®ƒå°† Agent çš„è¡Œä¸º**æ˜¾å¼åŒ–**ä¸ºä¸€ä¸ª**çŠ¶æ€å›¾**ã€‚

åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œ**Agent ä¸å†æ˜¯ä¸€ä¸ªå•ä¸€çš„â€œå¤§è„‘â€ï¼Œè€Œæ˜¯æ•´ä¸ªç”±èŠ‚ç‚¹å’Œè¾¹æ„æˆçš„ã€æœ‰çŠ¶æ€çš„ã€å¯é¢„æµ‹çš„å·¥ä½œæµæœ¬èº«**ã€‚èµ„æºæ„ŸçŸ¥ä¼˜åŒ–ä¸å†æ˜¯ Agent ä¼—å¤šèƒ½åŠ›ä¸­çš„ä¸€ä¸ªï¼Œè€Œæ˜¯**æ•´ä¸ªå·¥ä½œæµè®¾è®¡çš„æ ¸å¿ƒåŸåˆ™**ã€‚

---

### ä»£ç ç»“æ„è§£æï¼šå„ç»„ä»¶å¦‚ä½•ååŒå®ç°èµ„æºæ„ŸçŸ¥

#### 1. çŠ¶æ€çš„å®šä¹‰ï¼š`InspectionState` ç±»

```python
class InspectionState(TypedDict):
    batch_id: str
    constraints: Dict[str, float]  # èµ„æºçº¦æŸ
    initial_decision: str
    final_decision: str
    inspection_result: Dict[str, Any] # æ‰§è¡Œç»“æœ
    is_within_constraints: bool      # éªŒè¯ç»“æœ
    messages: Annotated[List[...], "Messages"]
```

*   **è§’è‰²**ï¼š**å…±äº«çš„è®°å¿†ä¸å·¥ä½œå°**ã€‚è¿™ä¸ª `TypedDict` æ˜¯æ•´ä¸ªå›¾çš„â€œå…¨å±€å˜é‡â€æˆ–â€œå…±äº«å†…å­˜â€ã€‚å®ƒæ‰¿è½½äº†ä»ä¸€ä¸ªèŠ‚ç‚¹æµå‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰ä¿¡æ¯ã€‚
*   **èµ„æºæ„ŸçŸ¥ä½“ç°**ï¼š
    *   **é›†ä¸­åŒ–ç®¡ç†**ï¼š`constraints` å­—æ®µå°†èµ„æºçº¦æŸä½œä¸ºçŠ¶æ€çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä½¿å¾—å›¾ä¸­çš„ä»»ä½•èŠ‚ç‚¹éƒ½å¯ä»¥è½»æ¾è®¿é—®å’Œåˆ©ç”¨è¿™äº›ä¿¡æ¯ã€‚
    *   **è¿‡ç¨‹è¿½è¸ª**ï¼š`initial_decision`, `final_decision`, `inspection_result`, `is_within_constraints` ç­‰å­—æ®µå…±åŒè®°å½•äº†æ•´ä¸ªèµ„æºæ„ŸçŸ¥å†³ç­–è¿‡ç¨‹çš„å®Œæ•´å†å²ã€‚è¿™ä¸ºè°ƒè¯•å’Œå®¡è®¡æä¾›äº†æå¤§çš„ä¾¿åˆ©ã€‚

#### 2. å·¥ä½œæµçš„åˆ†è§£ï¼šå›¾çš„èŠ‚ç‚¹

æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªåŠŸèƒ½æ˜ç¡®çš„å‡½æ•°ï¼Œå®ƒä»¬å…±åŒæ„æˆäº† Agent çš„èƒ½åŠ›ã€‚LangGraph å°†å¤æ‚çš„æµç¨‹åˆ†è§£ä¸ºä¸€ç³»åˆ—ç®€å•ã€å¯ç®¡ç†çš„æ­¥éª¤ã€‚

*   **`agent_node` (æ™ºèƒ½å†³ç­–)**
    *   **è§’è‰²**ï¼š**åˆ†æå¼•æ“**ã€‚è¿™ä¸ªèŠ‚ç‚¹æ˜¯ LLM å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ï¼Œä½†å®ƒåªè´Ÿè´£ä¸€ä»¶äº‹ï¼šæ ¹æ®çŠ¶æ€ä¸­çš„ `constraints` åšå‡ºåˆæ­¥å†³ç­–ã€‚
    *   **èµ„æºæ„ŸçŸ¥ä½“ç°**ï¼šå®ƒçš„å†³ç­–å®Œå…¨ä¾èµ–äºå¯¹èµ„æºçº¦æŸçš„ç†è§£ã€‚å®ƒå°†å†³ç­–ç»“æœå†™å…¥ `state["initial_decision"]`ï¼Œå°†æ¨ç†è¿‡ç¨‹ä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚

*   **`execute_inspection_node` (æ‰§è¡Œ)**
    *   **è§’è‰²**ï¼š**è¡ŒåŠ¨è€…**ã€‚å®ƒä¸æ€è€ƒï¼Œåªæ‰§è¡Œã€‚å®ƒè¯»å– `state["initial_decision"]`ï¼Œè°ƒç”¨ç›¸åº”çš„å·¥å…·ï¼Œå¹¶å°†æ‰§è¡Œç»“æœï¼ˆåŒ…æ‹¬å®é™…çš„æ—¶é—´å’Œæˆæœ¬æ¶ˆè€—ï¼‰å†™å…¥ `state["inspection_result"]`ã€‚
    *   **èµ„æºæ„ŸçŸ¥ä½“ç°**ï¼šè¿™æ˜¯èµ„æºæ¶ˆè€—çš„**å®é™…å‘ç”Ÿç‚¹**ã€‚å®ƒå°†ç†è®ºä¸Šçš„å†³ç­–è½¬åŒ–ä¸ºå®é™…çš„èµ„æºæ”¯å‡ºã€‚

*   **`check_constraints_node` (éªŒè¯)**
    *   **è§’è‰²**ï¼š**å®¡è®¡å®˜**ã€‚è¿™æ˜¯èµ„æºæ„ŸçŸ¥ä¼˜åŒ–ä¸­**è‡³å…³é‡è¦çš„ä¸€æ­¥**ã€‚å®ƒä¸å…³å¿ƒå†³ç­–æ˜¯ä»€ä¹ˆï¼Œåªå…³å¿ƒç»“æœæ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚
    *   **èµ„æºæ„ŸçŸ¥ä½“ç°**ï¼šå®ƒä» `state` ä¸­åŒæ—¶è¯»å– `constraints`ï¼ˆç›®æ ‡ï¼‰å’Œ `inspection_result`ï¼ˆå®é™…ï¼‰ï¼Œè¿›è¡Œæ¯”è¾ƒï¼Œå¹¶å°†å¸ƒå°”å€¼ç»“æœ `True/False` å†™å…¥ `state["is_within_constraints"]`ã€‚è¿™ä¸ªç®€å•çš„å¸ƒå°”å€¼å°†å†³å®šæ•´ä¸ªå·¥ä½œæµçš„ä¸‹ä¸€æ­¥èµ°å‘ã€‚

*   **`fallback_node` (å›é€€å†³ç­–)**
    *   **è§’è‰²**ï¼š**åº”æ€¥é¢„æ¡ˆ**ã€‚å½“ `check_constraints_node` çš„ç»“æœä¸º `False` æ—¶ï¼Œè¿™ä¸ªèŠ‚ç‚¹è¢«æ¿€æ´»ã€‚
    *   **èµ„æºæ„ŸçŸ¥ä½“ç°**ï¼šå®ƒä½“ç°äº†ç³»ç»Ÿçš„**éŸ§æ€§**å’Œ**ä¼˜é›…é™çº§**ã€‚å®ƒæ ¹æ®åˆå§‹å†³ç­–ï¼Œé€‰æ‹©ä¸€ä¸ªæ›´ä¿å®ˆã€æ›´çœèµ„æºçš„æ–¹æ¡ˆï¼Œå¹¶æ›´æ–° `state["final_decision"]`ã€‚

#### 3. é€»è¾‘çš„å®šä¹‰ï¼šå›¾çš„è¾¹

å¦‚æœè¯´èŠ‚ç‚¹å®šä¹‰äº†â€œèƒ½åšä»€ä¹ˆâ€ï¼Œé‚£ä¹ˆè¾¹å°±å®šä¹‰äº†â€œæŒ‰ä»€ä¹ˆé¡ºåºåšâ€ä»¥åŠâ€œåœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹åšâ€ã€‚è¿™æ˜¯ LangGraph æœ€å¼ºå¤§çš„åœ°æ–¹ã€‚

```python
# æ™®é€šçš„é¡ºåºæµ
workflow.add_edge("agent", "execute_inspection")
workflow.add_edge("execute_inspection", "check_constraints")

# ã€æ ¸å¿ƒã€‘æ¡ä»¶è¾¹
workflow.add_conditional_edges(
    "check_constraints",  # ä»å“ªä¸ªèŠ‚ç‚¹å¼€å§‹åˆ¤æ–­
    lambda state: "fallback" if not state["is_within_constraints"] else "final_report", # åˆ¤æ–­é€»è¾‘
    {
        "fallback": "fallback",       # å¦‚æœåˆ¤æ–­ä¸º 'fallback'ï¼Œå»å“ªé‡Œ
        "final_report": "final_report" # å¦‚æœåˆ¤æ–­ä¸º 'final_report'ï¼Œå»å“ªé‡Œ
    }
)
```

*   **è§’è‰²**ï¼š**å·¥ä½œæµçš„è§„åˆ™å¼•æ“**ã€‚
*   **èµ„æºæ„ŸçŸ¥ä½“ç°**ï¼š
    *   **æ˜¾å¼çš„å†³ç­–é€»è¾‘**ï¼šè¿™ä¸ª `add_conditional_edges` è°ƒç”¨æ˜¯æ•´ä¸ªèµ„æºæ„ŸçŸ¥ä¼˜åŒ–çš„**é€»è¾‘æ ¸å¿ƒ**ã€‚å®ƒå°†â€œå¦‚æœè¶…å‡ºèµ„æºï¼Œåˆ™å›é€€â€è¿™ä¸€ä¸šåŠ¡è§„åˆ™ï¼Œä»¥ä»£ç çš„å½¢å¼**å›ºåŒ–**åœ¨äº†å·¥ä½œæµä¸­ã€‚
    *   **ç¡®å®šæ€§**ï¼šä¸ä¾èµ– LLM ç†è§£â€œå¦‚æœå¤±è´¥äº†æ€ä¹ˆåŠâ€ç›¸æ¯”ï¼Œè¿™ç§åŸºäºçŠ¶æ€çš„æ˜¾å¼è·¯ç”±æ˜¯**ç¡®å®šä¸”å¯é¢„æµ‹çš„**ã€‚åªè¦ `is_within_constraints` ä¸º `False`ï¼Œæµç¨‹å°±**å¿…ç„¶**ä¼šè¿›å…¥ `fallback` èŠ‚ç‚¹ã€‚è¿™ä½¿å¾— Agent çš„è¡Œä¸ºæ›´åŠ å¯é å’Œå€¼å¾—ä¿¡èµ–ã€‚

### æ€»ç»“ï¼šLangGraph å¦‚ä½•æå‡èµ„æºæ„ŸçŸ¥ä¼˜åŒ–

1.  **æµç¨‹å¯è§†åŒ–ä¸å¯æ§æ€§**ï¼šæ•´ä¸ªèµ„æºæ„ŸçŸ¥ä¼˜åŒ–è¿‡ç¨‹ï¼ˆå†³ç­– -> æ‰§è¡Œ -> éªŒè¯ -> å›é€€ï¼‰è¢«æ¸…æ™°åœ°ç»˜åˆ¶æˆä¸€å¼ å›¾ã€‚å¼€å‘è€…å¯ä»¥ä¸€ç›®äº†ç„¶åœ°çœ‹åˆ°æ‰€æœ‰å¯èƒ½çš„è·¯å¾„å’ŒçŠ¶æ€ï¼Œæå¤§åœ°æå‡äº†ç³»ç»Ÿçš„å¯ç†è§£æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

2.  **é€»è¾‘ä¸å®ç°åˆ†ç¦»**ï¼šä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚â€œè¶…å‡ºé¢„ç®—å°±å›é€€â€ï¼‰è¢«ç¼–ç åœ¨å›¾çš„â€œè¾¹â€ä¸­ï¼Œè€Œå…·ä½“çš„æ“ä½œï¼ˆå¦‚â€œè°ƒç”¨AIæ£€æµ‹â€ï¼‰åˆ™å°è£…åœ¨â€œèŠ‚ç‚¹â€é‡Œã€‚è¿™ç§åˆ†ç¦»ä½¿å¾—ä¿®æ”¹å’Œæ‰©å±•å˜å¾—éå¸¸å®¹æ˜“ã€‚ä¾‹å¦‚ï¼Œæƒ³å¢åŠ ä¸€ä¸ªâ€œç”³è¯·é¢å¤–é¢„ç®—â€çš„èŠ‚ç‚¹ï¼Œåªéœ€åœ¨å›¾ä¸­æ·»åŠ æ–°çš„èŠ‚ç‚¹å’Œè¾¹å³å¯ã€‚

3.  **å¼ºå¤§çš„çŠ¶æ€ç®¡ç†**ï¼š`InspectionState` ä½œä¸ºå”¯ä¸€çš„æ•°æ®æºï¼Œè´¯ç©¿æ•´ä¸ªæµç¨‹ã€‚è¿™é¿å…äº†åœ¨å¤æ‚å·¥ä½œæµä¸­ä¼ é€’å’Œç®¡ç†å¤šä¸ªå˜é‡çš„éº»çƒ¦ï¼Œå¹¶å¤©ç„¶æ”¯æŒäº†æµç¨‹çš„æš‚åœã€æ¢å¤å’Œæ£€æŸ¥ç‚¹åŠŸèƒ½ã€‚

4.  **Agent å³å·¥ä½œæµ**ï¼šæœ€ç»ˆï¼Œè¿™ä¸ª Agent çš„â€œæ™ºèƒ½â€ä¸å†ä»…ä»…æ¥è‡ªäº LLMï¼Œè€Œæ˜¯æ¥è‡ªäº**æ•´ä¸ªç²¾å¿ƒè®¾è®¡çš„å·¥ä½œæµç»“æ„**ã€‚å®ƒçŸ¥é“å¦‚ä½•æ„ŸçŸ¥èµ„æºï¼ˆ`constraints`ï¼‰ï¼Œå¦‚ä½•å†³ç­–ï¼ˆ`agent_node`ï¼‰ï¼Œå¦‚ä½•è¡ŒåŠ¨ï¼ˆ`execute_*`ï¼‰ï¼Œå¦‚ä½•è‡ªæˆ‘è¯„ä¼°ï¼ˆ`check_constraints_node`ï¼‰ï¼Œä»¥åŠå¦‚ä½•ä»å¤±è´¥ä¸­æ¢å¤ï¼ˆ`fallback_node`ï¼‰ã€‚è¿™æ˜¯ä¸€ç§æ›´é«˜çº§ã€æ›´é²æ£’çš„ Agent å½¢æ€ã€‚
