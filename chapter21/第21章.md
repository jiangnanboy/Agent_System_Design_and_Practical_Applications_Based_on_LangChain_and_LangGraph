# æ™ºèƒ½ä½“å®æˆ˜ä¹‹æ¢ç´¢ä¸å‘ç°ï¼šä¸»åŠ¨è®¤çŸ¥æ‹“å±•çš„æ–°èŒƒå¼ 
![æ¢ç´¢ä¸å‘ç°](chapter21.png)

## ä¸€.ç®€ä»‹

## å¼•è¨€ï¼šè¶…è¶Šé¢„å®šä¹‰è¾¹ç•Œçš„æ™ºèƒ½ä½“

åœ¨äººå·¥æ™ºèƒ½çš„å‘å±•å†ç¨‹ä¸­ï¼Œæˆ‘ä»¬è§è¯äº†ä»è¢«åŠ¨æ‰§è¡ŒæŒ‡ä»¤åˆ°ä¸»åŠ¨æ¢ç´¢æœªçŸ¥çš„è½¬å˜ã€‚æ¢ç´¢ä¸å‘ç°æ¨¡å¼ä»£è¡¨äº†AI Agentçš„ä¸€ç§é«˜çº§èƒ½åŠ›ï¼Œä½¿å…¶èƒ½å¤Ÿè¶…è¶Šé¢„ç¼–ç¨‹çš„çŸ¥è¯†è¾¹ç•Œï¼Œä¸»åŠ¨å¯»æ±‚æ–°ä¿¡æ¯ã€å‘ç°æ–°å¯èƒ½æ€§å¹¶è¯†åˆ«ç¯å¢ƒä¸­çš„æœªçŸ¥å› ç´ ã€‚è¿™ç§èƒ½åŠ›ä¸åŒäºç®€å•çš„ä¼˜åŒ–æˆ–åœ¨å·²çŸ¥è§£å†³æ–¹æ¡ˆç©ºé—´å†…å¯»æ‰¾ç­”æ¡ˆï¼Œè€Œæ˜¯èµ‹äºˆAgentä¸€ç§ç±»ä¼¼äººç±»çš„å¥½å¥‡å¿ƒå’Œæ¢ç´¢æ¬²ï¼Œä½¿å…¶èƒ½å¤Ÿåœ¨å¤æ‚ã€å¼€æ”¾å’Œå¿«é€Ÿå˜åŒ–çš„ç¯å¢ƒä¸­è‡ªä¸»å¯¼èˆªã€‚

## æ ¸å¿ƒæ¦‚å¿µï¼šä¸»åŠ¨è®¤çŸ¥ä¸æœªçŸ¥æ¢ç´¢

æ¢ç´¢ä¸å‘ç°æ¨¡å¼çš„æ ¸å¿ƒåœ¨äºå°†AI Agentä»è¢«åŠ¨çš„å“åº”è€…è½¬å˜ä¸ºä¸»åŠ¨çš„æ¢ç´¢è€…ã€‚è¿™ç§æ¨¡å¼çš„å…³é”®ç‰¹å¾åŒ…æ‹¬ï¼š

- **ä¸»åŠ¨ä¿¡æ¯è·å–**ï¼šAgentèƒ½å¤Ÿè‡ªä¸»è¯†åˆ«çŸ¥è¯†ç©ºç™½å¹¶ä¸»åŠ¨å¯»æ‰¾ç›¸å…³ä¿¡æ¯
- **å¯èƒ½æ€§ç©ºé—´æ‰©å±•**ï¼šä¸å±€é™äºå·²çŸ¥è§£å†³æ–¹æ¡ˆï¼Œè€Œæ˜¯æ¢ç´¢å…¨æ–°çš„å¯èƒ½æ€§
- **æœªçŸ¥å› ç´ è¯†åˆ«**ï¼šèƒ½å¤Ÿå‘ç°å¹¶è¡¨å¾"æœªçŸ¥çš„æœªçŸ¥"å› ç´ 
- **çŸ¥è¯†ç”Ÿæˆ**ï¼šé€šè¿‡æ¢ç´¢è¿‡ç¨‹åˆ›é€ æ–°çš„ç†è§£å’ŒçŸ¥è¯†

è¿™ç§æ¨¡å¼å¯¹äºåœ¨å¼€æ”¾å¼ã€å¤æ‚æˆ–å¿«é€Ÿæ¼”å˜çš„ç¯å¢ƒä¸­è¿è¡Œçš„Agentè‡³å…³é‡è¦ï¼Œå› ä¸ºåœ¨è¿™äº›ç¯å¢ƒä¸­ï¼Œé™æ€çŸ¥è¯†æˆ–é¢„ç¼–ç¨‹çš„è§£å†³æ–¹æ¡ˆå¾€å¾€ä¸è¶³ä»¥åº”å¯¹æŒ‘æˆ˜ã€‚å®ƒå¼ºè°ƒçš„æ˜¯Agentæ‰©å±•è‡ªèº«ç†è§£å’Œèƒ½åŠ›çš„èƒ½åŠ›ï¼Œè€Œéç®€å•åœ°æ‰§è¡Œé¢„è®¾ä»»åŠ¡ã€‚

## å®é™…åº”ç”¨ï¼šå¤šé¢†åŸŸçš„æ¢ç´¢ä¸åˆ›æ–°

æ¢ç´¢ä¸å‘ç°æ¨¡å¼åœ¨å„ä¸ªé¢†åŸŸéƒ½æœ‰å¹¿æ³›åº”ç”¨ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å…¸å‹åœºæ™¯ï¼š

- **ç§‘å­¦ç ”ç©¶**ï¼šAI Agentå¯ä»¥è®¾è®¡å®éªŒã€åˆ†æç»“æœå¹¶æå‡ºæ–°å‡è®¾ï¼ŒåŠ é€Ÿç§‘å­¦å‘ç°è¿‡ç¨‹
- **æˆ˜ç•¥è§„åˆ’**ï¼šåœ¨å•†ä¸šæˆ–å†›äº‹é¢†åŸŸï¼Œæ¢ç´¢å¤šç§å¯èƒ½çš„æœªæ¥æƒ…æ™¯å¹¶åˆ¶å®šåº”å¯¹ç­–ç•¥
- **åˆ›æ„äº§ä¸š**ï¼šæ¢ç´¢é£æ ¼ã€ä¸»é¢˜æˆ–æ•°æ®çš„æ–°ç»„åˆï¼Œç”Ÿæˆåˆ›æ–°çš„è‰ºæœ¯ã€éŸ³ä¹æˆ–æ–‡å­¦ä½œå“
- **å®‰å…¨åˆ†æ**ï¼šä¸»åŠ¨æ¢æµ‹ç³»ç»Ÿæˆ–ç½‘ç»œä¸­çš„æ½œåœ¨æ¼æ´å’Œå¨èƒ
- **æ•™è‚²ä¸ªæ€§åŒ–**ï¼šæ ¹æ®å­¦ä¹ è€…çš„æƒ…å†µåŠ¨æ€è°ƒæ•´æ•™å­¦å†…å®¹å’Œè·¯å¾„
- **å¸‚åœºæ´å¯Ÿ**ï¼šåˆ†æéç»“æ„åŒ–æ•°æ®ä»¥è¯†åˆ«æ–°å…´è¶‹åŠ¿å’Œæ¶ˆè´¹è€…è¡Œä¸ºå˜åŒ–

## äºŒ.å®è·µæ¡ˆä¾‹ï¼šæ™ºèƒ½ç½‘ç»œå®‰å…¨æ¼æ´åˆ†æç³»ç»Ÿ

è¯¥ç³»ç»Ÿèƒ½å¤Ÿä¸»åŠ¨æ¢æµ‹ç³»ç»Ÿæˆ–ç½‘ç»œä¸­çš„æ½œåœ¨æ¼æ´å’Œå¨èƒã€‚è¿™ä¸ªç³»ç»Ÿæ¨¡æ‹Ÿäº†å®‰å…¨ä¸“å®¶çš„åˆ†æè¿‡ç¨‹ï¼Œé€šè¿‡å¤šAgentåä½œæ¥å…¨é¢è¯„ä¼°ç½‘ç»œç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚  

å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆï¼š 

    ç½‘ç»œæ‰«æAgentï¼šè´Ÿè´£æ”¶é›†ç›®æ ‡ç³»ç»Ÿçš„åŸºæœ¬ä¿¡æ¯ 
    æ¼æ´åˆ†æAgentï¼šä½¿ç”¨DeepSeekåˆ†ææ½œåœ¨æ¼æ´ 
    å¨èƒè¯„ä¼°Agentï¼šè¯„ä¼°å‘ç°çš„å¨èƒçš„ä¸¥é‡ç¨‹åº¦ 
    æŠ¥å‘Šç”ŸæˆAgentï¼šç”Ÿæˆè¯¦ç»†çš„å®‰å…¨æŠ¥å‘Šå’Œå»ºè®® 

## ä¸‰.langchainå®ç°
```python
from typing import Optional

from langchain_classic.agents import create_openai_tools_agent, AgentExecutor
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.tools import Tool

from init_client import init_llm

llm = init_llm(temperature=0.2)


# ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿæœç´¢ç»“æœ
def local_search(query: str) -> str:
    """ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿæœç´¢ç»“æœ"""
    # è¿™é‡Œå¯ä»¥æ ¹æ®å…³é”®è¯è¿”å›ä¸€äº›é¢„å®šä¹‰çš„æœç´¢ç»“æœ
    # å®é™…åº”ç”¨ä¸­ï¼Œå¯ä»¥æ„å»ºä¸€ä¸ªæœ¬åœ°çŸ¥è¯†åº“æˆ–ä½¿ç”¨ç¦»çº¿æœç´¢å¼•æ“

    # æ¨¡æ‹Ÿä¸€äº›å¸¸è§æ¼æ´çš„æœç´¢ç»“æœ
    if "CVE" in query or "vulnerability" in query.lower():
        return """
        å¸¸è§æ¼æ´ä¿¡æ¯ï¼š
        1. CVE-2023-1234: Apache Struts2 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼Œå½±å“ç‰ˆæœ¬2.0.0-2.5.30
        2. CVE-2023-5678: OpenSSL æ‹’ç»æœåŠ¡æ¼æ´ï¼Œå½±å“ç‰ˆæœ¬1.1.1-1.1.1t
        3. CVE-2023-9012: Spring Framework è·¯å¾„éå†æ¼æ´ï¼Œå½±å“ç‰ˆæœ¬5.3.0-5.3.31
        """
    elif "apache" in query.lower():
        return """
        Apacheå¸¸è§å®‰å…¨é—®é¢˜ï¼š
        1. é»˜è®¤é…ç½®å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯
        2. æ—§ç‰ˆæœ¬å¯èƒ½å­˜åœ¨å·²çŸ¥æ¼æ´
        3. ä¸å®‰å…¨çš„HTTPæ–¹æ³•å¯èƒ½è¢«å¯ç”¨
        """
    elif "ssh" in query.lower():
        return """
        SSHå¸¸è§å®‰å…¨é—®é¢˜ï¼š
        1. å¼±å¯†ç æˆ–é»˜è®¤å¯†ç 
        2. ä½¿ç”¨ä¸å®‰å…¨çš„åŠ å¯†ç®—æ³•
        3. å…è®¸rootç”¨æˆ·ç›´æ¥ç™»å½•
        4. æœªé™åˆ¶ç™»å½•å°è¯•æ¬¡æ•°
        """
    else:
        return "æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯ã€‚è¯·å°è¯•æ›´å…·ä½“çš„æœç´¢è¯ï¼Œå¦‚'Apache CVE'æˆ–'SSHå®‰å…¨é…ç½®'ã€‚"


# ä½¿ç”¨æœ¬åœ°æ¼æ´æ•°æ®åº“
def local_vulnerability_db(component: str, version: str = "") -> str:
    """æŸ¥è¯¢æœ¬åœ°æ¼æ´æ•°æ®åº“"""
    # è¿™é‡Œå¯ä»¥ç»´æŠ¤ä¸€ä¸ªæœ¬åœ°æ¼æ´æ•°æ®åº“ï¼Œå¦‚JSONæ–‡ä»¶æˆ–SQLiteæ•°æ®åº“
    # ç¤ºä¾‹ä¸­ä½¿ç”¨ç®€å•çš„å­—å…¸

    vulnerability_db = {
        "apache": {
            "2.4.48": ["CVE-2021-34798: mod_proxy æ¼æ´", "CVE-2021-36160: è·¯å¾„éå†æ¼æ´"],
            "2.4.49": ["CVE-2021-40438: mod_proxy æ¼æ´", "CVE-2021-44790: ç¼“å†²åŒºæº¢å‡º"],
            "2.4.50": ["CVE-2021-41773: è·¯å¾„éå†æ¼æ´", "CVE-2021-42013: è·¯å¾„éå†æ¼æ´"]
        },
        "openssh": {
            "8.2p1": ["CVE-2021-28041: scp å®¢æˆ·ç«¯æ¼æ´"],
            "8.5p1": ["CVE-2021-41617: ç‰¹æƒæå‡æ¼æ´"],
            "9.0p1": ["CVE-2023-25136: å‰ç½®æ¡ä»¶ç«äº‰æ¼æ´"]
        },
        "nginx": {
            "1.18.0": ["CVE-2021-23017: è§£æå™¨æ¼æ´"],
            "1.20.1": ["CVE-2021-3618: å†…å­˜æ³„æ¼æ¼æ´"],
            "1.21.6": ["CVE-2022-41741: å†…å­˜æŸåæ¼æ´"]
        }
    }

    component = component.lower()
    if component in vulnerability_db:
        if version and version in vulnerability_db[component]:
            return f"{component} {version} çš„å·²çŸ¥æ¼æ´: {', '.join(vulnerability_db[component][version])}"
        else:
            all_vulns = []
            for ver, vulns in vulnerability_db[component].items():
                all_vulns.extend(vulns)
            return f"{component} çš„å·²çŸ¥æ¼æ´: {', '.join(all_vulns)}"
    else:
        return f"æœªæ‰¾åˆ° {component} çš„æ¼æ´ä¿¡æ¯"


# å®šä¹‰å·¥å…·
tools = [
    Tool(
        name="NetworkScan",
        func=lambda target: "æ¨¡æ‹Ÿç½‘ç»œæ‰«æç»“æœï¼šå‘ç°ç«¯å£22(SSH), 80(HTTP), 443(HTTPS)",
        description="å¯¹ç›®æ ‡IPæˆ–åŸŸåæ‰§è¡ŒåŸºæœ¬çš„ç½‘ç»œæ‰«æï¼Œè¯†åˆ«å¼€æ”¾ç«¯å£å’ŒæœåŠ¡"
    ),
    Tool(
        name="WebCrawl",
        func=lambda url: f"æ¨¡æ‹Ÿç½‘é¡µå†…å®¹çˆ¬å–ï¼šä» {url} è·å–åˆ°æœåŠ¡å™¨ä¿¡æ¯ï¼šApache/2.4.49",
        description="çˆ¬å–ç½‘ç«™çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬HTMLå†…å®¹å’Œå“åº”å¤´"
    ),
    Tool(
        name="LocalSearch",
        func=local_search,
        description="ä½¿ç”¨æœ¬åœ°æœç´¢åŠŸèƒ½æŸ¥æ‰¾å®‰å…¨ç›¸å…³ä¿¡æ¯ï¼Œä¸éœ€è¦å¤–ç½‘è®¿é—®"
    ),
    Tool(
        name="LocalVulnerabilityDB",
        func=local_vulnerability_db,
        description="æŸ¥è¯¢æœ¬åœ°æ¼æ´æ•°æ®åº“ï¼ŒæŸ¥æ‰¾å·²çŸ¥ç»„ä»¶çš„æ¼æ´ä¿¡æ¯"
    ),
    Tool(
        name="DeepSeekAnalyze",
        func=lambda x: llm.invoke(
            f"ä½œä¸ºç½‘ç»œå®‰å…¨ä¸“å®¶ï¼Œè¯·åˆ†æä»¥ä¸‹ä¿¡æ¯ä¸­çš„æ½œåœ¨å®‰å…¨æ¼æ´å’Œå¨èƒ:\n\n{x}\n\nè¯·æä¾›:\n1. å‘ç°çš„æ½œåœ¨æ¼æ´åˆ—è¡¨\n2. æ¯ä¸ªæ¼æ´çš„ä¸¥é‡ç¨‹åº¦è¯„ä¼°(é«˜/ä¸­/ä½)\n3. å¯èƒ½çš„æ”»å‡»å‘é‡\n4. å»ºè®®çš„ä¿®å¤æªæ–½"),
        description="ä½¿ç”¨DeepSeekè¿›è¡Œæ·±åº¦å®‰å…¨åˆ†æï¼Œè¯†åˆ«ä»£ç æˆ–é…ç½®ä¸­çš„æ½œåœ¨æ¼æ´"
    )
]

# åˆ›å»ºAgent
# 1. ç½‘ç»œæ‰«æAgent
network_scanner_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€åç½‘ç»œå®‰å…¨ä¸“å®¶ï¼Œè´Ÿè´£å¯¹ç›®æ ‡ç³»ç»Ÿè¿›è¡Œåˆæ­¥æ‰«æå’Œä¿¡æ¯æ”¶é›†ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä½¿ç”¨NetworkScanå’ŒWebCrawlå·¥å…·æ”¶é›†ç›®æ ‡çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¸ºåç»­åˆ†æåšå‡†å¤‡ã€‚"),
    ("user", "{input}"),
    ("assistant", "{agent_scratchpad}")
])

network_scanner_agent = create_openai_tools_agent(llm, tools, network_scanner_prompt)
network_scanner_executor = AgentExecutor(agent=network_scanner_agent, tools=tools, verbose=True)

# 2. æ¼æ´åˆ†æAgent
vulnerability_analyzer_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€åæ¼æ´åˆ†æä¸“å®¶ï¼Œè´Ÿè´£åˆ†æç³»ç»Ÿé…ç½®å’Œä»£ç ä¸­çš„æ½œåœ¨å®‰å…¨æ¼æ´ã€‚ä½¿ç”¨DeepSeekAnalyzeå·¥å…·è¿›è¡Œæ·±åº¦åˆ†æï¼Œå¹¶ä½¿ç”¨LocalVulnerabilityDBå’ŒLocalSearchæŸ¥æ‰¾å·²çŸ¥æ¼æ´ã€‚"),
    ("user", "{input}"),
    ("assistant", "{agent_scratchpad}")
])

vulnerability_analyzer_agent = create_openai_tools_agent(llm, tools, vulnerability_analyzer_prompt)
vulnerability_analyzer_executor = AgentExecutor(agent=vulnerability_analyzer_agent, tools=tools, verbose=True)

# 3. å¨èƒè¯„ä¼°Agent
threat_assessor_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€åå¨èƒè¯„ä¼°ä¸“å®¶ï¼Œè´Ÿè´£è¯„ä¼°å·²å‘ç°æ¼æ´çš„å¨èƒç¨‹åº¦å’Œæ½œåœ¨å½±å“ã€‚ä½ éœ€è¦è€ƒè™‘æ¼æ´çš„ä¸¥é‡æ€§ã€åˆ©ç”¨éš¾åº¦å’Œæ½œåœ¨çš„ä¸šåŠ¡å½±å“ã€‚"),
    ("user", "{input}"),
    ("assistant", "{agent_scratchpad}")
])

threat_assessor_agent = create_openai_tools_agent(llm, tools, threat_assessor_prompt)
threat_assessor_executor = AgentExecutor(agent=threat_assessor_agent, tools=tools, verbose=True)

# 4. æŠ¥å‘Šç”ŸæˆAgent
report_generator_prompt = ChatPromptTemplate.from_messages([
    ("system", "ä½ æ˜¯ä¸€åå®‰å…¨æŠ¥å‘Šä¸“å®¶ï¼Œè´Ÿè´£ç”Ÿæˆè¯¦ç»†çš„å®‰å…¨è¯„ä¼°æŠ¥å‘Šï¼ŒåŒ…æ‹¬å‘ç°çš„æ¼æ´ã€å¨èƒè¯„ä¼°å’Œä¿®å¤å»ºè®®ã€‚æŠ¥å‘Šåº”è¯¥æ¸…æ™°ã€ä¸“ä¸šä¸”å¯æ“ä½œã€‚"),
    ("user", "{input}"),
    ("assistant", "{agent_scratchpad}")
])

report_generator_agent = create_openai_tools_agent(llm, tools, report_generator_prompt)
report_generator_executor = AgentExecutor(agent=report_generator_agent, tools=tools, verbose=True)


# ä¸»å‡½æ•°
def security_analysis(target: str, config_or_code: Optional[str] = None) -> str:
    """æ‰§è¡Œå®Œæ•´çš„å®‰å…¨åˆ†ææµç¨‹"""

    # é˜¶æ®µ1ï¼šç½‘ç»œæ‰«æå’Œä¿¡æ¯æ”¶é›†
    print("=== é˜¶æ®µ1ï¼šç½‘ç»œæ‰«æå’Œä¿¡æ¯æ”¶é›† ===")
    scan_result = network_scanner_executor.invoke({
        "input": f"è¯·å¯¹ç›®æ ‡ {target} è¿›è¡Œç½‘ç»œæ‰«æå’Œä¿¡æ¯æ”¶é›†ï¼ŒåŒ…æ‹¬å¼€æ”¾ç«¯å£ã€è¿è¡Œçš„æœåŠ¡å’Œç½‘ç«™åŸºæœ¬ä¿¡æ¯ã€‚"
    })

    # é˜¶æ®µ2ï¼šæ¼æ´åˆ†æ
    print("\n=== é˜¶æ®µ2ï¼šæ¼æ´åˆ†æ ===")
    vulnerability_input = f"åŸºäºä»¥ä¸‹æ‰«æç»“æœåˆ†ææ½œåœ¨æ¼æ´ï¼š\n{scan_result['output']}"
    if config_or_code:
        vulnerability_input += f"\n\nåŒæ—¶åˆ†æä»¥ä¸‹é…ç½®æˆ–ä»£ç ä¸­çš„å®‰å…¨æ¼æ´ï¼š\n{config_or_code}"

    vulnerability_result = vulnerability_analyzer_executor.invoke({
        "input": vulnerability_input
    })

    # é˜¶æ®µ3ï¼šå¨èƒè¯„ä¼°
    print("\n=== é˜¶æ®µ3ï¼šå¨èƒè¯„ä¼° ===")
    threat_result = threat_assessor_executor.invoke({
        "input": f"åŸºäºä»¥ä¸‹æ¼æ´åˆ†æç»“æœï¼Œè¯„ä¼°æ¯ä¸ªæ¼æ´çš„å¨èƒç¨‹åº¦å’Œæ½œåœ¨å½±å“ï¼š\n{vulnerability_result['output']}"
    })

    # é˜¶æ®µ4ï¼šç”ŸæˆæŠ¥å‘Š
    print("\n=== é˜¶æ®µ4ï¼šç”Ÿæˆå®‰å…¨æŠ¥å‘Š ===")
    report_input = f"""
    åŸºäºä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆè¯¦ç»†çš„å®‰å…¨è¯„ä¼°æŠ¥å‘Šï¼š

    1. æ‰«æç»“æœï¼š
    {scan_result['output']}

    2. æ¼æ´åˆ†æï¼š
    {vulnerability_result['output']}

    3. å¨èƒè¯„ä¼°ï¼š
    {threat_result['output']}

    æŠ¥å‘Šåº”åŒ…æ‹¬ï¼š
    - æ‰§è¡Œæ‘˜è¦
    - å‘ç°çš„æ¼æ´åˆ—è¡¨åŠä¸¥é‡ç¨‹åº¦
    - æ½œåœ¨ä¸šåŠ¡å½±å“
    - è¯¦ç»†çš„ä¿®å¤å»ºè®®
    - é•¿æœŸå®‰å…¨æ”¹è¿›æªæ–½
    """

    report_result = report_generator_executor.invoke({
        "input": report_input
    })

    return report_result['output']


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # ç¤ºä¾‹1ï¼šæ¨¡æ‹Ÿåˆ†æç½‘ç«™
    target_website = "example.com"
    security_report = security_analysis(target_website)
    print("=== å®‰å…¨åˆ†ææŠ¥å‘Š ===")
    print(security_report)

    # ç¤ºä¾‹2ï¼šåˆ†æç½‘ç»œé…ç½®
    network_config = """
    # è·¯ç”±å™¨é…ç½®
    interface GigabitEthernet0/0
     ip address 192.168.1.1 255.255.255.0
     no shutdown
    !
    line vty 0 4
     password cisco123
     login
    !
    enable secret 5 $1$mERr$hh5V0fV9B9kXpWEp6oY6X.
    """

    security_report_config = security_analysis("192.168.1.1", network_config)
    print("\n=== ç½‘ç»œé…ç½®å®‰å…¨åˆ†ææŠ¥å‘Š ===")
    print(security_report_config)
```

## é¡¹ç›®åˆ†æ

### 1. ä»â€œè¢«åŠ¨åŒ¹é…â€åˆ°â€œä¸»åŠ¨æ¨ç†â€çš„è®¤çŸ¥é£è·ƒ

è¿™æ˜¯è¯¥èŒƒå¼æœ€æ ¸å¿ƒçš„ä½“ç°ã€‚

*   **æ—§èŒƒå¼ï¼ˆè¢«åŠ¨åŒ¹é…ï¼‰**ï¼šä¼ ç»Ÿçš„æ¼æ´æ‰«æå™¨ï¼Œå…¶æœ¬è´¨æ˜¯ä¸€ä¸ªâ€œæ•°æ®åº“æŸ¥è¯¢å·¥å…·â€ã€‚å®ƒå°†æ‰«æåˆ°çš„è½¯ä»¶ç‰ˆæœ¬ï¼ˆå¦‚ Apache 2.4.49ï¼‰ä¸ä¸€ä¸ªå·²çŸ¥çš„CVEæ¼æ´æ•°æ®åº“è¿›è¡Œæ¯”å¯¹ã€‚å¦‚æœåŒ¹é…ï¼Œå°±æŠ¥å‘Šä¸€ä¸ªå·²çŸ¥æ¼æ´ã€‚å®ƒçš„èƒ½åŠ›ä¸Šé™æ˜¯å…¶æ•°æ®åº“çš„å¤§å°ï¼Œå®ƒåªèƒ½å‘ç°â€œ**å·²çŸ¥çš„å·²çŸ¥**â€ã€‚

*   **æœ¬æ¡ˆä¾‹ï¼ˆä¸»åŠ¨æ¨ç†ï¼‰**ï¼šç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯ `DeepSeekAnalyze` å·¥å…·ã€‚å½“å®ƒæ¥æ”¶åˆ°ä¸€æ®µç½‘ç»œé…ç½®æˆ–ä»£ç æ—¶ï¼Œå®ƒä¸æ˜¯åœ¨æŸ¥æ‰¾å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯åœ¨è¿›è¡Œ**æ·±åº¦æ¨ç†**ã€‚
    *   **ä»£ç ä½“ç°**ï¼š
        ```python
        def deepseek_analyze_security(code_or_config: str, analysis_type: str) -> str:
            prompt = f"""
            ä½œä¸ºç½‘ç»œå®‰å…¨ä¸“å®¶ï¼Œè¯·åˆ†æä»¥ä¸‹{analysis_type}ä¸­çš„æ½œåœ¨å®‰å…¨æ¼æ´å’Œå¨èƒ:
            
            {code_or_config}
            
            è¯·æä¾›:
            1. å‘ç°çš„æ½œåœ¨æ¼æ´åˆ—è¡¨
            2. æ¯ä¸ªæ¼æ´çš„ä¸¥é‡ç¨‹åº¦è¯„ä¼°(é«˜/ä¸­/ä½)
            3. å¯èƒ½çš„æ”»å‡»å‘é‡
            4. å»ºè®®çš„ä¿®å¤æªæ–½
            """
            response = llm.invoke(prompt)
            return response
        ```
    *   **èŒƒå¼è§£è¯»**ï¼šè¿™é‡Œçš„ `llm.invoke(prompt)` è§¦å‘çš„æ˜¯ä¸€ä¸ªè®¤çŸ¥è¿‡ç¨‹ã€‚DeepSeekæ¨¡å‹ä¼š**ç†è§£**é…ç½®çš„è¯­ä¹‰ï¼Œ**æ¨ç†**å…¶ä¸­çš„é€»è¾‘å…³ç³»ã€‚å®ƒå¯èƒ½ä¼šå‘ç°ï¼š
        *   **é€»è¾‘æ¼æ´**ï¼šâ€œè™½ç„¶Aå’ŒBä¸¤æ¡è§„åˆ™å•ç‹¬çœ‹æ˜¯å®‰å…¨çš„ï¼Œä½†å®ƒä»¬çš„ç»„åˆåœ¨ç‰¹å®šæµé‡æ¨¡å¼ä¸‹ä¼šäº§ç”Ÿä¸€ä¸ªç«æ€æ¡ä»¶ï¼Œå¯¼è‡´æƒé™ç»•è¿‡ã€‚â€ è¿™ç§æ¼æ´å‡ ä¹ä¸å¯èƒ½å‡ºç°åœ¨ä»»ä½•CVEæ•°æ®åº“ä¸­ã€‚
        *   **ä¸Šä¸‹æ–‡é£é™©**ï¼šâ€œè¿™ä¸ªé…ç½®åœ¨æµ‹è¯•ç¯å¢ƒä¸­æ˜¯å®‰å…¨çš„ï¼Œä½†æš´éœ²åœ¨å…¬ç½‘ä¸Šä¼šæ³„éœ²å†…éƒ¨ç½‘ç»œæ‹“æ‰‘ã€‚â€
        *   **éæ ‡å‡†å¨èƒ**ï¼šâ€œè¿™ä¸ªè‡ªå®šä¹‰è„šæœ¬è™½ç„¶å®ç°äº†åŠŸèƒ½ï¼Œä½†å…¶é”™è¯¯å¤„ç†æœºåˆ¶ä¸å½“ï¼Œå¯èƒ½è¢«ç”¨æ¥è¿›è¡ŒDoSæ”»å‡»ã€‚â€

    è¿™å°±æ˜¯**ä¸»åŠ¨æ¢ç´¢**æœªçŸ¥å¨èƒç©ºé—´ï¼Œä»â€œåŒ¹é…â€å‡çº§åˆ°äº†â€œ**å‘ç°**â€ã€‚

### 2. è¶…è¶Šé¢„å®šä¹‰çŸ¥è¯†è¾¹ç•Œï¼Œç”Ÿæˆâ€œæ–°çŸ¥è¯†â€

è¯¥ç³»ç»Ÿçš„ç›®æ ‡ä¸æ˜¯å¤è¿°ä¿¡æ¯ï¼Œè€Œæ˜¯åˆ›é€ æ–°çš„è§è§£ã€‚

*   **æ—§èŒƒå¼**ï¼šè¾“å‡ºæ˜¯æ¼æ´åˆ—è¡¨å’ŒCVEç¼–å·ã€‚
*   **æœ¬æ¡ˆä¾‹**ï¼šè¾“å‡ºæ˜¯ç»“æ„åŒ–çš„ã€åŒ…å«**æ–°è§è§£**çš„æŠ¥å‘Šã€‚
    *   **ä»£ç ä½“ç°**ï¼šæ•´ä¸ªå¤šAgentå·¥ä½œæµçš„è®¾è®¡å°±æ˜¯ä¸ºäº†çŸ¥è¯†çš„ç”Ÿæˆã€‚
        1.  `network_scanner` æ”¶é›†åŸå§‹æ•°æ®ã€‚
        2.  `vulnerability_analyzer` å°†åŸå§‹æ•°æ®è½¬åŒ–ä¸ºåˆæ­¥çš„å®‰å…¨æ´å¯Ÿã€‚
        3.  `threat_assessor` è¯„ä¼°è¿™äº›æ´å¯Ÿçš„å½±å“ï¼Œç”Ÿæˆâ€œå¨èƒç­‰çº§â€å’Œâ€œä¸šåŠ¡å½±å“â€ç­‰æ–°ä¿¡æ¯ã€‚
        4.  `report_generator` å°†æ‰€æœ‰ç¢ç‰‡åŒ–çš„ä¿¡æ¯**ç»¼åˆã€æç‚¼ã€å‡å**ï¼Œå½¢æˆä¸€ä»½å…·æœ‰æˆ˜ç•¥ä»·å€¼çš„æŠ¥å‘Šã€‚
    *   **èŒƒå¼è§£è¯»**ï¼š`report_generator` Agentçš„æç¤ºè¯æ˜ç¡®è¦æ±‚å®ƒä¸ä»…ä»…æ˜¯ç½—åˆ—ï¼Œè€Œæ˜¯è¦**ç”Ÿæˆ**â€œæ‰§è¡Œæ‘˜è¦â€ã€â€œæ½œåœ¨ä¸šåŠ¡å½±å“â€å’Œâ€œé•¿æœŸå®‰å…¨æ”¹è¿›æªæ–½â€ã€‚è¿™äº›å†…å®¹åœ¨è¾“å…¥ä¿¡æ¯ä¸­æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ˜¯ç³»ç»Ÿé€šè¿‡**è®¤çŸ¥æ‹“å±•**åˆ›é€ å‡ºæ¥çš„æ–°çŸ¥è¯†ã€‚å®ƒå°†åˆ†æ•£çš„æŠ€æœ¯ç‚¹ï¼Œè¿æ¥æˆäº†ä¸€ä¸ªæœ‰ä»·å€¼çš„å•†ä¸šæˆ–æˆ˜ç•¥å™äº‹ã€‚

### 3. é€šè¿‡å¤šAgentåä½œæ¨¡æ‹Ÿå¤æ‚è®¤çŸ¥è¿‡ç¨‹

äººç±»çš„æ¢ç´¢ä¸å‘ç°å¾€å¾€ä¸æ˜¯å•æ‰“ç‹¬æ–—ï¼Œè€Œæ˜¯å›¢é˜Ÿåä½œçš„ç»“æœã€‚è¿™ä¸ªç³»ç»Ÿå·§å¦™åœ°æ¨¡æ‹Ÿäº†è¿™ä¸€ç‚¹ã€‚

*   **ä»£ç ä½“ç°**ï¼šç³»ç»Ÿå®šä¹‰äº†å››ä¸ªå…·æœ‰ä¸åŒâ€œä¸“ä¸šâ€å’Œâ€œè®¤çŸ¥è§’è‰²â€çš„Agentï¼š
    *   `network_scanner`ï¼š**æ„ŸçŸ¥ä¸ä¿¡æ¯æ”¶é›†è€…**ã€‚å®ƒçš„ä»»åŠ¡æ˜¯â€œçœ‹â€å’Œâ€œå¬â€ï¼Œä¸ºç³»ç»Ÿæä¾›åŸå§‹ç´ æã€‚
    *   `vulnerability_analyzer`ï¼š**åˆ†æå¸ˆä¸ä¾¦æ¢**ã€‚å®ƒçš„ä»»åŠ¡æ˜¯æ·±å…¥æŒ–æ˜ï¼Œå¯»æ‰¾çº¿ç´¢å’Œè¯æ®ã€‚
    *   `threat_assessor`ï¼š**é£é™©è¯„ä¼°å¸ˆä¸æˆ˜ç•¥å®¶**ã€‚å®ƒçš„ä»»åŠ¡æ˜¯è¯„ä¼°å‘ç°çš„å¨èƒæœ‰å¤šå¤§ï¼Œä»¥åŠå¯èƒ½é€ æˆçš„åæœã€‚
    *   `report_generator`ï¼š**æ²Ÿé€šè€…ä¸æŠ¥å‘Šæ’°å†™äºº**ã€‚å®ƒçš„ä»»åŠ¡æ˜¯æ•´åˆæ‰€æœ‰å‘ç°ï¼Œå¹¶ä»¥æ¸…æ™°ã€æœ‰è¯´æœåŠ›çš„æ–¹å¼å‘ˆç°å‡ºæ¥ã€‚
*   **èŒƒå¼è§£è¯»**ï¼šè¿™ç§åˆ†å·¥åä½œä½¿å¾—æ•´ä¸ªç³»ç»Ÿèƒ½å¤Ÿå¤„ç†ä¸€ä¸ªæå…¶å¤æ‚çš„å¼€æ”¾å¼é—®é¢˜â€”â€”â€œè¯„ä¼°è¿™ä¸ªç³»ç»Ÿçš„å®‰å…¨æ€§â€ã€‚æ¯ä¸ªAgentä¸“æ³¨äºä¸€ä¸ªè®¤çŸ¥å­ä»»åŠ¡ï¼Œå®ƒä»¬çš„è¾“å‡ºä¸²è”èµ·æ¥ï¼Œå°±å½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„ã€ä»æ•°æ®åˆ°æ™ºæ…§çš„è®¤çŸ¥é“¾æ¡ã€‚è¿™è¿œæ¯”ä¸€ä¸ªå•ä¸€ã€åºå¤§çš„ç¨‹åºè¦çµæ´»å’Œå¼ºå¤§ï¼Œä¹Ÿæ›´æ¥è¿‘äººç±»çš„æ™ºæ…§å·¥ä½œæ–¹å¼ã€‚

### 4. åœ¨å¼€æ”¾å¼ç¯å¢ƒä¸­è¿›è¡Œé€‚åº”æ€§æ¢ç´¢

ç°å®ä¸–ç•Œçš„ç½‘ç»œç¯å¢ƒæ˜¯å¤æ‚ã€å¤šå˜ä¸”ä¿¡æ¯ä¸å®Œæ•´çš„ã€‚ä¸€ä¸ªå¥½çš„æ¢ç´¢ç³»ç»Ÿå¿…é¡»èƒ½åº”å¯¹è¿™ç§ä¸ç¡®å®šæ€§ã€‚

*   **ä»£ç ä½“ç°**ï¼š
    *   å·¥å…·çš„è®¾è®¡å…è®¸å¤„ç†ä¸å®Œç¾çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œ`LocalSearch` å’Œ `LocalVulnerabilityDB` æä¾›äº†åŸºç¡€ä¸Šä¸‹æ–‡ï¼Œä½†çœŸæ­£çš„æ¢ç´¢èƒ½åŠ›æ¥è‡ªäº `DeepSeekAnalyze` å¯¹è¿™äº›ä¿¡æ¯çš„**è¶…è¶Šæ€§è§£è¯»**ã€‚
    *   æ•´ä¸ªå·¥ä½œæµæ˜¯**æ•°æ®é©±åŠ¨**çš„ã€‚`vulnerability_analyzer` çš„è¾“å…¥æ˜¯ `network_scanner` çš„è¾“å‡ºã€‚è¿™æ„å‘³ç€å¦‚æœæ‰«æç»“æœä¸åŒï¼Œåç»­çš„åˆ†æè·¯å¾„ä¹Ÿä¼šå®Œå…¨ä¸åŒã€‚ç³»ç»Ÿä¼šæ ¹æ®å®ƒâ€œçœ‹åˆ°â€çš„ä¸œè¥¿æ¥å†³å®šä¸‹ä¸€æ­¥â€œæƒ³â€ä»€ä¹ˆã€‚
*   **èŒƒå¼è§£è¯»**ï¼šç³»ç»Ÿæ²¡æœ‰è¢«å†™æ­»â€œå¦‚æœçœ‹åˆ°Apache 2.4.49ï¼Œå°±æŠ¥å‘ŠCVE-2021-41773â€ã€‚ç›¸åï¼Œå®ƒçš„æŒ‡ä»¤æ˜¯â€œåˆ†æä½ çœ‹åˆ°çš„ä¸œè¥¿ï¼Œå¹¶å‘Šè¯‰æˆ‘è¿™æ„å‘³ç€ä»€ä¹ˆâ€ã€‚è¿™ç§**é€‚åº”æ€§**æ˜¯ä¸»åŠ¨æ¢ç´¢çš„å…³é”®ã€‚å®ƒå…è®¸ç³»ç»Ÿåœ¨é¢å¯¹å‰æ‰€æœªè§çš„é…ç½®æˆ–è½¯ä»¶æ—¶ï¼Œä¾ç„¶èƒ½å¤ŸåŸºäºå…¶æ¨ç†èƒ½åŠ›åšå‡ºæœ‰ä»·å€¼çš„åˆ¤æ–­ï¼Œä»è€Œå®ç°äº†è®¤çŸ¥è¾¹ç•Œçš„**æ‹“å±•**ã€‚

## å››.langgraphå®ç°
```python
from typing import Optional, List

from typing_extensions import TypedDict, Annotated
from langchain_core.messages import BaseMessage, HumanMessage, AIMessage
from langgraph.graph import StateGraph, END
from langgraph.checkpoint.memory import MemorySaver
from init_client import init_llm

# --- 1. åˆå§‹åŒ–æ ¸å¿ƒæ¨¡å‹ ---
llm = init_llm(temperature=0.2)

# --- 2. å®šä¹‰â€œè®¤çŸ¥çŠ¶æ€â€ ---
class SecurityAnalysisState(TypedDict):
    target: str
    config_or_code: Optional[str]
    # messages åˆ—è¡¨è®°å½•äº†æ•´ä¸ªæ¢ç´¢è¿‡ç¨‹çš„â€œæ€è€ƒè½¨è¿¹â€
    messages: Annotated[List[BaseMessage], "The messages in the conversation"]
    scan_results: Optional[str]
    vulnerability_analysis: Optional[str]
    threat_assessment: Optional[str]
    final_report: Optional[str]


# --- 3. å®šä¹‰â€œå·¥å…·â€å‡½æ•°ï¼ˆæ¨¡æ‹Ÿå¤–éƒ¨çŸ¥è¯†è·å–ï¼‰ ---

def local_search(query: str) -> str:
    """æ¨¡æ‹Ÿæœ¬åœ°æœç´¢ï¼Œæä¾›ä¸Šä¸‹æ–‡çŸ¥è¯†ã€‚"""
    if "CVE" in query or "vulnerability" in query.lower():
        return "å¸¸è§æ¼æ´ä¿¡æ¯ï¼šCVE-2023-1234 (Apache RCE), CVE-2023-5678 (OpenSSL DoS)"
    elif "apache" in query.lower():
        return "Apacheå¸¸è§å®‰å…¨é—®é¢˜ï¼šé»˜è®¤é…ç½®æ³„éœ²ã€æ—§ç‰ˆæœ¬æ¼æ´ã€ä¸å®‰å…¨çš„HTTPæ–¹æ³•ã€‚"
    else:
        return "æœªæ‰¾åˆ°ç›¸å…³ä¿¡æ¯ã€‚"


def local_vulnerability_db(component: str, version: str = "") -> str:
    """æŸ¥è¯¢æœ¬åœ°æ¼æ´æ•°æ®åº“ã€‚"""
    db = {
        "apache": {"2.4.49": "å­˜åœ¨è·¯å¾„éå†æ¼æ´ (CVE-2021-41773) å’Œ mod_proxy æ¼æ´ (CVE-2021-40438)ã€‚"},
        "openssh": {"8.2p1": "å­˜åœ¨scpå®¢æˆ·ç«¯ä¿¡æ¯æ³„éœ²æ¼æ´ (CVE-2021-28041)ã€‚"}
    }
    if component.lower() in db:
        return db[component.lower()].get(version, f"æ‰¾åˆ° {component} çš„ç›¸å…³æ¼æ´ä¿¡æ¯ã€‚")
    return f"æœªæ‰¾åˆ° {component} çš„æ¼æ´ä¿¡æ¯ã€‚"


# --- 4. å®šä¹‰â€œè®¤çŸ¥èŠ‚ç‚¹â€ ---

def initial_scan_node(state: SecurityAnalysisState):
    """èŠ‚ç‚¹1ï¼šä¿¡æ¯æ”¶é›†ä¸åˆæ­¥æ‰«æ"""
    print("--- ğŸ” æ‰§è¡ŒèŠ‚ç‚¹1: åˆå§‹æ‰«æä¸ä¿¡æ¯æ”¶é›† ---")
    # æ¨¡æ‹Ÿæ‰«æç»“æœï¼Œä»¥ä½“ç°æ¢ç´¢çš„èµ·ç‚¹
    simulated_scan_result = f"å¯¹ {state['target']} çš„æ‰«æç»“æœï¼š\n- å¼€æ”¾ç«¯å£: 22(SSH), 80(HTTP)\n- WebæœåŠ¡å™¨: Apache/2.4.49\n- SSHç‰ˆæœ¬: OpenSSH_8.2p1"

    # å°†å‘ç°ä½œä¸ºæ¶ˆæ¯æ·»åŠ åˆ°çŠ¶æ€ä¸­ï¼Œå½¢æˆâ€œæ€è€ƒé“¾â€
    new_message = AIMessage(content=f"åˆæ­¥æ‰«æå®Œæˆã€‚å‘ç°:\n{simulated_scan_result}")

    return {"scan_results": simulated_scan_result, "messages": [new_message]}


def vulnerability_analysis_node(state: SecurityAnalysisState):
    """èŠ‚ç‚¹2ï¼šæ·±åº¦æ¼æ´åˆ†æï¼ˆæ ¸å¿ƒæ¢ç´¢ä¸å‘ç°ï¼‰"""
    print("\n--- ğŸ§  æ‰§è¡ŒèŠ‚ç‚¹2: æ·±åº¦æ¼æ´åˆ†æ ---")

    # æ„å»ºä¸€ä¸ªå¤æ‚çš„æç¤ºï¼Œå¼•å¯¼ LLM è¿›è¡Œä¸»åŠ¨æ¨ç†å’Œæ¢ç´¢
    analysis_prompt = f"""
    ä½œä¸ºä¸€åèµ„æ·±çš„ç½‘ç»œå®‰å…¨ä¸“å®¶ï¼Œè¯·åŸºäºä»¥ä¸‹ä¿¡æ¯è¿›è¡Œæ·±åº¦åˆ†æã€‚
    ä½ çš„ä»»åŠ¡ä¸ä»…ä»…æ˜¯åŒ¹é…å·²çŸ¥æ¼æ´ï¼Œæ›´æ˜¯è¦**æ¨ç†å’Œå‘ç°æ½œåœ¨çš„ã€ç»„åˆå¼çš„å®‰å…¨é£é™©**ã€‚

    **æ‰«æç»“æœ:**
    {state['scan_results']}

    **æœ¬åœ°çŸ¥è¯†åº“æŸ¥è¯¢:**
    - Apache 2.4.49: {local_vulnerability_db('apache', '2.4.49')}
    - OpenSSH 8.2p1: {local_vulnerability_db('openssh', '8.2p1')}

    **åˆ†æè¦æ±‚:**
    1.  **å…³è”åˆ†æ**: ç»“åˆæ‰«æç»“æœå’Œæœ¬åœ°çŸ¥è¯†ï¼Œè¯„ä¼°è¿™äº›æœåŠ¡åŒæ—¶è¿è¡Œå¯èƒ½å¸¦æ¥çš„å¤åˆé£é™©ã€‚
    2.  **æ¨ç†æœªçŸ¥**: åŸºäºè¿™äº›ç‰ˆæœ¬ï¼Œæ¨æµ‹å¯èƒ½å­˜åœ¨çš„ã€å°šæœªè¢«å¹¿æ³›è®°å½•çš„é…ç½®é”™è¯¯æˆ–é€»è¾‘æ¼æ´ã€‚
    3.  **ç”Ÿæˆæ–°çŸ¥**: æå‡ºä¸€ä¸ªä½ çš„ç‹¬ç‰¹è§è§£ï¼Œä¾‹å¦‚ä¸€ä¸ªéæ ‡å‡†çš„æ”»å‡»å‘é‡æˆ–ä¸€ä¸ªå®¹æ˜“è¢«å¿½è§†çš„å®‰å…¨éšæ‚£ã€‚

    è¯·æä¾›ç»“æ„åŒ–çš„åˆ†ææŠ¥å‘Šã€‚
    """

    # ä½¿ç”¨ llm è¿›è¡Œæ·±åº¦åˆ†æï¼Œè¿™æ˜¯ä»â€œæ•°æ®â€åˆ°â€œæ´å¯Ÿâ€çš„å…³é”®ä¸€æ­¥
    analysis = llm.invoke(analysis_prompt)

    new_message = AIMessage(content=f"æ·±åº¦æ¼æ´åˆ†æå®Œæˆã€‚åˆ†æç»“æœ:\n{analysis.content}")

    return {"vulnerability_analysis": analysis.content, "messages": [new_message]}


def threat_assessment_node(state: SecurityAnalysisState):
    """èŠ‚ç‚¹3ï¼šå¨èƒè¯„ä¼°ä¸ä¼˜å…ˆçº§æ’åº"""
    print("\n--- âš–ï¸ æ‰§è¡ŒèŠ‚ç‚¹3: å¨èƒè¯„ä¼° ---")

    assessment_prompt = f"""
    ä½œä¸ºä¸€åå®‰å…¨ä¸»ç®¡ï¼Œè¯·å¯¹ä»¥ä¸‹æ¼æ´åˆ†æç»“æœè¿›è¡Œå¨èƒè¯„ä¼°ã€‚

    **æ¼æ´åˆ†ææŠ¥å‘Š:**
    {state['vulnerability_analysis']}

    **è¯„ä¼°æ ‡å‡†:**
    - å¯åˆ©ç”¨æ€§: æ”»å‡»è€…åˆ©ç”¨è¯¥æ¼æ´çš„éš¾æ˜“ç¨‹åº¦ã€‚
    - å½±å“èŒƒå›´: æˆåŠŸæ”»å‡»åå¯èƒ½å¯¹ä¸šåŠ¡é€ æˆçš„æŸå®³ã€‚
    - ä¿®å¤æˆæœ¬: ä¿®å¤è¯¥æ¼æ´æ‰€éœ€çš„æ—¶é—´å’Œèµ„æºã€‚

    è¯·ä¸ºæ¯ä¸ªå‘ç°çš„æ¼æ´è¯„å®šä¸€ä¸ªå¨èƒç­‰çº§ï¼ˆé«˜ã€ä¸­ã€ä½ï¼‰ï¼Œå¹¶è§£é‡ŠåŸå› ã€‚æœ€åï¼Œç»™å‡ºä¸€ä¸ªä¿®å¤ä¼˜å…ˆçº§çš„å»ºè®®ã€‚
    """

    assessment = llm.invoke(assessment_prompt)

    new_message = AIMessage(content=f"å¨èƒè¯„ä¼°å®Œæˆã€‚è¯„ä¼°ç»“æœ:\n{assessment.content}")

    return {"threat_assessment": assessment.content, "messages": [new_message]}


def report_generation_node(state: SecurityAnalysisState):
    """èŠ‚ç‚¹4ï¼šç»¼åˆæŠ¥å‘Šç”Ÿæˆ"""
    print("\n--- ğŸ“„ æ‰§è¡ŒèŠ‚ç‚¹4: ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š ---")

    report_prompt = f"""
    è¯·å°†ä»¥ä¸‹æ‰€æœ‰åˆ†æè¿‡ç¨‹å’Œç»“æœï¼Œæ•´åˆæˆä¸€ä»½ä¸“ä¸šçš„å®‰å…¨è¯„ä¼°æŠ¥å‘Šã€‚

    **ç›®æ ‡:** {state['target']}
    **æ‰«æç»“æœ:** {state['scan_results']}
    **æ¼æ´åˆ†æ:** {state['vulnerability_analysis']}
    **å¨èƒè¯„ä¼°:** {state['threat_assessment']}

    æŠ¥å‘Šåº”åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š
    1. æ‰§è¡Œæ‘˜è¦
    2. è¯¦ç»†å‘ç°
    3. é£é™©è¯„ä¼°ä¸ä¼˜å…ˆçº§
    4. å¯æ“ä½œçš„ä¿®å¤å»ºè®®
    5. ç»“è®º
    """

    final_report = llm.invoke(report_prompt)

    new_message = AIMessage(content=f"æœ€ç»ˆæŠ¥å‘Šå·²ç”Ÿæˆã€‚")

    return {"final_report": final_report.content, "messages": [new_message]}

# --- 5. æ„å»ºå¹¶ç¼–è¯‘â€œè®¤çŸ¥å·¥ä½œæµå›¾â€ ---

def create_security_analysis_workflow():
    workflow = StateGraph(SecurityAnalysisState)

    # æ·»åŠ èŠ‚ç‚¹
    workflow.add_node("initial_scan", initial_scan_node)
    workflow.add_node("vulnerability_analysis", vulnerability_analysis_node)
    workflow.add_node("threat_assessment", threat_assessment_node)
    workflow.add_node("report_generation", report_generation_node)

    # å®šä¹‰å…¥å£ç‚¹
    workflow.set_entry_point("initial_scan")

    # å®šä¹‰è¾¹ï¼ˆæµç¨‹ï¼‰-> è¿™å®šä¹‰äº†è®¤çŸ¥çš„çº¿æ€§æ¨è¿›è·¯å¾„
    workflow.add_edge("initial_scan", "vulnerability_analysis")
    workflow.add_edge("vulnerability_analysis", "threat_assessment")
    workflow.add_edge("threat_assessment", "report_generation")
    workflow.add_edge("report_generation", END)

    # ç¼–è¯‘å›¾ï¼Œæ·»åŠ å†…å­˜ä»¥ä¿å­˜çŠ¶æ€
    memory = MemorySaver()
    app = workflow.compile(checkpointer=memory)

    return app


# --- 6. æ‰§è¡Œæ¢ç´¢ä¸å‘ç°æµç¨‹ ---

def run_security_analysis(target: str, config_or_code: Optional[str] = None):
    """å¯åŠ¨å¹¶è¿è¡Œæ•´ä¸ªå®‰å…¨åˆ†æå·¥ä½œæµã€‚"""

    # åˆ›å»ºå·¥ä½œæµå®ä¾‹
    app = create_security_analysis_workflow()

    # åˆå§‹åŒ–çŠ¶æ€
    initial_state = {
        "target": target,
        "config_or_code": config_or_code,
        "messages": [HumanMessage(content=f"å¼€å§‹å¯¹ {target} è¿›è¡Œå…¨é¢çš„å®‰å…¨åˆ†æã€‚")],
        "scan_results": None,
        "vulnerability_analysis": None,
        "threat_assessment": None,
        "final_report": None
    }

    # æ‰§è¡Œå·¥ä½œæµï¼Œthread_id ç”¨äºåœ¨å†…å­˜ä¸­è·Ÿè¸ªç‰¹å®šä¼šè¯
    config = {"configurable": {"thread_id": "security-analysis-001"}}
    final_state = app.invoke(initial_state, config)

    # æ‰“å°å®Œæ•´çš„æ€è€ƒè½¨è¿¹
    print("\n\n===== å®Œæ•´çš„è®¤çŸ¥æ¢ç´¢è½¨è¿¹ =====")
    for message in final_state["messages"]:
        print(f"{message.type}: {message.content[:100]}...")

    # è¿”å›æœ€ç»ˆå‘ç°
    return final_state["final_report"]

if __name__ == "__main__":
    # æ¨¡æ‹Ÿç½‘ç«™
    target_system = "internal-web-server.example.com"
    final_security_report = run_security_analysis(target_system)

    print("\n\n===============================")
    print("   æœ€ç»ˆå®‰å…¨åˆ†ææŠ¥å‘Š")
    print("===============================")
    print(final_security_report)
```

## é¡¹ç›®åˆ†æ

### 1. æ˜¾å¼çš„â€œè®¤çŸ¥çŠ¶æ€â€ä»£è¡¨çŸ¥è¯†çš„ç´¯ç§¯

è¿™æ˜¯è¯¥èŒƒå¼æœ€æ ¸å¿ƒçš„ä½“ç°ï¼Œä¹Ÿæ˜¯ LangGraph ç›¸è¾ƒäºå…¶ä»–æ¡†æ¶æœ€ç‹¬ç‰¹çš„ä¼˜åŠ¿ã€‚

*   **æ—§èŒƒå¼ï¼ˆä¿¡æ¯å­¤å²›ï¼‰**ï¼šåœ¨ä¼ ç»Ÿçš„è„šæœ¬æˆ–ç®€å•çš„ Agent é“¾ä¸­ï¼Œä¿¡æ¯é€šè¿‡å‡½æ•°å‚æ•°ä¼ æ¥ä¼ å»ï¼Œæ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„ã€æ¼”è¿›çš„â€œçŸ¥è¯†ä½“â€ã€‚ç³»ç»Ÿçš„â€œè®°å¿†â€æ˜¯ç¢ç‰‡åŒ–çš„ã€‚

*   **æœ¬æ¡ˆä¾‹ï¼ˆç»Ÿä¸€è®¤çŸ¥çŠ¶æ€ï¼‰**ï¼š
    *   **ä»£ç ä½“ç°**ï¼š
        ```python
        class SecurityAnalysisState(TypedDict):
            target: str
            messages: Annotated[List[BaseMessage], "The messages in the conversation"]
            scan_results: Optional[str]
            vulnerability_analysis: Optional[str]
            # ... å…¶ä»–çŠ¶æ€å­—æ®µ
        ```
    *   **èŒƒå¼è§£è¯»**ï¼š`SecurityAnalysisState` ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯æ•´ä¸ªç³»ç»Ÿçš„**æ ¸å¿ƒè®°å¿†å’Œè®¤çŸ¥è½½ä½“**ã€‚å®ƒä»£è¡¨äº†ç³»ç»Ÿåœ¨æ¢ç´¢è¿‡ç¨‹ä¸­çš„**å®Œæ•´è®¤çŸ¥çŠ¶æ€**ã€‚æ¯ç»è¿‡ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒçŠ¶æ€å°±è¢«æ›´æ–°ï¼Œæ–°çš„å‘ç°è¢«æ•´åˆè¿›æ¥ã€‚è¿™å®Œç¾æ¨¡æ‹Ÿäº†äººç±»ä¸“å®¶åœ¨åˆ†æè¿‡ç¨‹ä¸­ä¸æ–­ç§¯ç´¯ä¿¡æ¯ã€ä¿®æ­£å‡è®¾ã€æ·±åŒ–ç†è§£çš„è¿‡ç¨‹ã€‚ç‰¹åˆ«æ˜¯ `messages` å­—æ®µï¼Œå®ƒè®°å½•äº†æ•´ä¸ªâ€œæ€è€ƒé“¾â€ï¼Œä½¿è®¤çŸ¥è¿‡ç¨‹å®Œå…¨é€æ˜ã€å¯è¿½æº¯ã€‚**ç³»ç»Ÿåœ¨æ¢ç´¢ï¼Œå®ƒçš„â€œä¸–ç•Œè§‚â€ï¼ˆStateï¼‰å°±åœ¨ä¸æ–­æ‹“å±•ã€‚**

### 2. â€œè®¤çŸ¥èŠ‚ç‚¹â€æ˜¯ä¸“é—¨åŒ–çš„æ¢ç´¢æ¨¡å—

äººç±»çš„æ¢ç´¢ä¸å‘ç°å¾€å¾€ä¸æ˜¯å•æ‰“ç‹¬æ–—ï¼Œè€Œæ˜¯å›¢é˜Ÿåä½œçš„ç»“æœã€‚è¿™ä¸ªç³»ç»Ÿå·§å¦™åœ°æ¨¡æ‹Ÿäº†è¿™ä¸€ç‚¹ã€‚

*   **æ—§èŒƒå¼ï¼ˆæ··æ²Œçš„å•ä¸€æ™ºèƒ½ä½“ï¼‰**ï¼šä¸€ä¸ªå•ä¸€çš„ Agent å¾ªç¯ï¼Œæ ¹æ® LLM çš„åˆ¤æ–­è°ƒç”¨å·¥å…·ï¼Œè¿‡ç¨‹ç›¸å¯¹â€œæ··æ²Œâ€ï¼Œç¼ºä¹ç»“æ„åŒ–çš„åˆ†å·¥ã€‚

*   **æœ¬æ¡ˆä¾‹ï¼ˆç»“æ„åŒ–çš„ä¸“å®¶å›¢é˜Ÿï¼‰**ï¼š
    *   **ä»£ç ä½“ç°**ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è®¤çŸ¥åŠŸèƒ½æ¨¡å—ï¼Œæ‹¥æœ‰æ˜ç¡®çš„â€œä¸“ä¸šâ€å’Œâ€œè®¤çŸ¥è§’è‰²â€ã€‚
        ```python
        def vulnerability_analysis_node(state: SecurityAnalysisState):
            # ...
            analysis_prompt = f"""
            ...
            2.  **æ¨ç†æœªçŸ¥**: åŸºäºè¿™äº›ç‰ˆæœ¬ï¼Œæ¨æµ‹å¯èƒ½å­˜åœ¨çš„ã€å°šæœªè¢«å¹¿æ³›è®°å½•çš„é…ç½®é”™è¯¯æˆ–é€»è¾‘æ¼æ´ã€‚
            3.  **ç”Ÿæˆæ–°çŸ¥**: æå‡ºä¸€ä¸ªä½ çš„ç‹¬ç‰¹è§è§£...
            """
            analysis = llm.invoke(analysis_prompt)
            # ...
        ```
    *   **èŒƒå¼è§£è¯»**ï¼šè¿™ç§åˆ†å·¥åä½œä½¿å¾—æ•´ä¸ªç³»ç»Ÿèƒ½å¤Ÿå¤„ç†ä¸€ä¸ªæå…¶å¤æ‚çš„å¼€æ”¾å¼é—®é¢˜ã€‚æ¯ä¸ªèŠ‚ç‚¹ä¸“æ³¨äºä¸€ä¸ªè®¤çŸ¥å­ä»»åŠ¡ï¼š
        *   `initial_scan_node`ï¼š**æ„ŸçŸ¥ä¸ä¿¡æ¯æ”¶é›†è€…**ã€‚
        *   `vulnerability_analysis_node`ï¼š**åˆ†æå¸ˆä¸ä¾¦æ¢**ã€‚è¿™æ˜¯â€œæ¢ç´¢ä¸å‘ç°â€çš„æ ¸å¿ƒã€‚å®ƒçš„æç¤ºè¯æ˜ç¡®è¦æ±‚ LLM **è¶…è¶Šå·²çŸ¥ä¿¡æ¯ï¼Œè¿›è¡Œå…³è”æ¨ç†å’Œç”Ÿæˆæ–°çŸ¥**ï¼Œè€Œä¸æ˜¯ç®€å•åœ°åŒ¹é… CVEã€‚
        *   `threat_assessment_node`ï¼š**é£é™©è¯„ä¼°å¸ˆä¸æˆ˜ç•¥å®¶**ã€‚
        *   `report_generation_node`ï¼š**æ²Ÿé€šè€…ä¸æŠ¥å‘Šæ’°å†™äºº**ã€‚
    è¿™ç§æ¨¡å—åŒ–ä½¿å¾—ç³»ç»Ÿæ›´å¼ºå¤§ã€æ›´æ˜“äºç†è§£ï¼Œä¹Ÿæ›´æ¥è¿‘äººç±»æ™ºæ…§å·¥ä½œæ–¹å¼ã€‚

### 3. â€œå·¥ä½œæµå›¾â€å®šä¹‰äº†ç»“æ„åŒ–çš„æ¢ç´¢è·¯å¾„

ç°å®ä¸–ç•Œçš„ç½‘ç»œç¯å¢ƒæ˜¯å¤æ‚ã€å¤šå˜ä¸”ä¿¡æ¯ä¸å®Œæ•´çš„ã€‚ä¸€ä¸ªå¥½çš„æ¢ç´¢ç³»ç»Ÿå¿…é¡»èƒ½åº”å¯¹è¿™ç§ä¸ç¡®å®šæ€§ã€‚

*   **æ—§èŒƒå¼ï¼ˆéšæœºçš„æ¢ç´¢è·¯å¾„ï¼‰**ï¼šæ¢ç´¢è·¯å¾„æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œä¾èµ–äº LLM çš„æ¯ä¸€æ¬¡å†³ç­–ï¼Œè™½ç„¶çµæ´»ä½†å¯èƒ½ç¼ºä¹å…¨å±€æœ€ä¼˜æ€§å’Œä¸¥è°¨æ€§ã€‚

*   **æœ¬æ¡ˆä¾‹ï¼ˆç§‘å­¦åŒ–çš„æ¢ç´¢æµç¨‹ï¼‰**ï¼š
    *   **ä»£ç ä½“ç°**ï¼š
        ```python
        workflow.add_edge("initial_scan", "vulnerability_analysis")
        workflow.add_edge("vulnerability_analysis", "threat_assessment")
        workflow.add_edge("threat_assessment", "report_generation")
        ```
    *   **èŒƒå¼è§£è¯»**ï¼š`StateGraph` æ˜ç¡®å®šä¹‰äº†ä¸€ä¸ª**ç»“æ„åŒ–çš„ã€çº¿æ€§çš„è®¤çŸ¥è·¯å¾„**ã€‚è¿™ä»£è¡¨äº†ä¸€ç§æˆç†Ÿçš„ã€ç»è¿‡éªŒè¯çš„ç§‘å­¦æ¢ç´¢æ–¹æ³•ï¼š
        1.  æ”¶é›†æ•°æ® (`initial_scan`)
        2.  åˆ†ææ•°æ®ï¼Œå½¢æˆå‡è®¾ (`vulnerability_analysis`)
        3.  è¯„ä¼°å‡è®¾çš„é‡è¦æ€§ (`threat_assessment`)
        4.  å¾—å‡ºç»“è®º (`report_generation`)
    è¿™ç§ç¡®å®šæ€§ç¡®ä¿äº†æ¢ç´¢è¿‡ç¨‹çš„ä¸¥è°¨æ€§å’Œå®Œæ•´æ€§ï¼Œé¿å…äº†é—æ¼å…³é”®æ­¥éª¤ã€‚å®ƒå°†ä¸€ä¸ªå¤æ‚çš„å¼€æ”¾å¼é—®é¢˜ï¼Œåˆ†è§£ä¸ºä¸€ç³»åˆ—å¯ç®¡ç†çš„ã€æœ‰åºçš„è®¤çŸ¥é˜¶æ®µã€‚**ç³»ç»Ÿä¸æ˜¯åœ¨éšæœºæ¼«æ­¥ï¼Œè€Œæ˜¯åœ¨éµå¾ªä¸€å¼ è®¤çŸ¥åœ°å›¾è¿›è¡Œæœ‰åºæ¢ç´¢ã€‚**

### 4. ä»â€œååº”å¼å·¥å…·è°ƒç”¨â€åˆ°â€œä¸»åŠ¨å¼çŠ¶æ€æ¼”è¿›â€

è¿™æ˜¯å¯¹ç³»ç»Ÿè‡ªä¸»æ€§å±‚æ¬¡çš„æ·±åˆ»æ´å¯Ÿã€‚

*   **æ—§èŒƒå¼ï¼ˆååº”å¼ï¼‰**ï¼š`LangChain Agent` é€šå¸¸æ˜¯ååº”å¼çš„ï¼šâ€œæˆ‘çœ‹åˆ°ä¸€ä¸ªç»“æœï¼Œæˆ‘å†³å®šä¸‹ä¸€ä¸ªå·¥å…·ã€‚â€ å®ƒçš„æ„å›¾æ˜¯å±€éƒ¨çš„ã€å³æ—¶çš„ã€‚

*   **æœ¬æ¡ˆä¾‹ï¼ˆä¸»åŠ¨å¼ä¸çŠ¶æ€é©±åŠ¨ï¼‰**ï¼š
    *   **ä»£ç ä½“ç°**ï¼šæ•´ä¸ªæµç¨‹çš„é©±åŠ¨åŠ›æ˜¯**çŠ¶æ€çš„æ¼”è¿›**ã€‚æ¯ä¸ªèŠ‚ç‚¹çš„ç›®æ ‡å°±æ˜¯å°†å½“å‰çŠ¶æ€æ¨è¿›åˆ°ä¸‹ä¸€ä¸ªæ›´ä¸°å¯Œçš„çŠ¶æ€ã€‚
        ```python
        def initial_scan_node(state: SecurityAnalysisState):
            # ...
            return {"scan_results": simulated_scan_result, "messages": [new_message]}
        ```
    *   **èŒƒå¼è§£è¯»**ï¼šç³»ç»Ÿçš„â€œæ„å›¾â€ä¸æ˜¯â€œæˆ‘ä¸‹ä¸€æ­¥è¯¥è°ƒç”¨å“ªä¸ªå·¥å…·ï¼Ÿâ€ï¼Œè€Œæ˜¯â€œæˆ‘è¯¥å¦‚ä½•å®Œæˆæˆ‘çš„è®¤çŸ¥ä»»åŠ¡ï¼Œä»¥æ›´æ–°æ•´ä½“çŠ¶æ€ï¼Ÿâ€ã€‚è¿™æ˜¯ä¸€ç§æ›´é«˜å±‚æ¬¡çš„è‡ªä¸»æ€§ï¼Œæ›´æ¥è¿‘äºäººç±»è®¾å®šç›®æ ‡å¹¶åˆ†æ­¥å®ç°çš„è¿‡ç¨‹ã€‚**ç³»ç»Ÿè¢«ä¸€ä¸ªæ›´é«˜å±‚æ¬¡çš„ç›®æ ‡â€”â€”â€œå®Œæˆå®‰å…¨åˆ†æâ€â€”â€”æ‰€é©±åŠ¨ï¼Œè€Œä¸æ˜¯è¢«åº•å±‚çš„å·¥å…·é€‰æ‹©æ‰€é©±åŠ¨ã€‚**

